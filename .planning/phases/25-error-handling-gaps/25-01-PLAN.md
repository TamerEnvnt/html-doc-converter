---
phase: 25-error-handling-gaps
plan: 01
type: execute
---

<objective>
Fix 3 error handling gaps: check command unhandled rejections, DOCX mkdir wrong error code, and addStyleTag raw Puppeteer errors.

Purpose: These gaps cause incorrect error codes, unhandled rejections, or raw library errors leaking to users instead of clean ConversionError messages.
Output: All 3 gaps fixed with regression tests. Consistent error handling across all code paths.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependency context:
@.planning/phases/24-critical-bug-fixes/24-01-SUMMARY.md

# Source files to modify:
@src/cli.ts
@src/converters/docx-converter.ts
@src/converters/pdf-converter.ts

# Test files to extend:
@tests/cli.test.ts
@tests/converters/docx-converter.test.ts
@tests/converters/pdf-converter.test.ts

**Established patterns:**
- Throw-on-failure: converters throw ConversionError, callers use try/catch [Phase 17]
- Error cause chains: always pass { cause: error } when re-throwing [Phase 20]
- Finally-block cleanup: wrap close/cleanup calls in try/catch [Phase 24]
- closeBrowser() safe for finally blocks - never throws [Phase 16]

**Constraining decisions:**
- ErrorCodes.OUTPUT_DIR_FAILED exists for directory creation failures (used in cli.ts:132-135)
- ErrorCodes.PDF_FAILED exists for generic PDF failures
- ConversionError is the user-facing error type (via formatError)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add try/catch to check command</name>
  <files>src/cli.ts, tests/cli.test.ts</files>
  <action>
In cli.ts lines 250-264, the `check` command's action handler has no error handling. If `checkDependencies()` or `formatDependencyReport()` throws, it becomes an unhandled promise rejection.

Wrap the entire action body in try/catch, following the same pattern as the main conversion action (lines 81-247):
```typescript
.action(async () => {
  try {
    console.log('');
    console.log('Checking dependencies...');
    console.log('');
    const result = await checkDependencies();
    console.log(formatDependencyReport(result));
    console.log('');
    process.exit(result.allFound ? 0 : 1);
  } catch (error) {
    console.error('');
    if (error instanceof ConversionError) {
      console.error(formatError(error));
    } else {
      console.error('Error checking dependencies:', error instanceof Error ? error.message : error);
    }
    console.error('');
    process.exit(1);
  }
});
```

Do NOT add a finally block here - closeBrowser() is not relevant to the check command (it doesn't launch a browser).

Add a test in cli.test.ts that verifies the check command handles errors gracefully (mock checkDependencies to throw, verify process.exit(1) is called).
  </action>
  <verify>npx vitest run tests/cli.test.ts --reporter=verbose passes</verify>
  <done>check command has try/catch. Errors produce clean output and exit code 1 instead of unhandled rejection.</done>
</task>

<task type="auto">
  <name>Task 2: Fix DOCX mkdir error code from DOCX_FAILED to OUTPUT_DIR_FAILED</name>
  <files>src/converters/docx-converter.ts, tests/converters/docx-converter.test.ts</files>
  <action>
In docx-converter.ts line 61, `fs.mkdir(outputDir, { recursive: true })` has no error handling. If it fails, the error falls to the generic catch at lines 96-100 which wraps it as `ErrorCodes.DOCX_FAILED`. This is incorrect - directory creation failure should use `ErrorCodes.OUTPUT_DIR_FAILED`.

Wrap the mkdir call (line 61) in its own try/catch:
```typescript
try {
  await fs.mkdir(outputDir, { recursive: true });
} catch (err) {
  throw createError(
    ErrorCodes.OUTPUT_DIR_FAILED,
    `${outputDir}: ${err instanceof Error ? err.message : 'unknown error'}`,
  );
}
```

This follows the same pattern as cli.ts lines 129-136 (the main action handler's directory creation).

Note: The error cause chain pattern (Phase 20) is NOT used here because createError doesn't accept a cause parameter - it constructs a message string. This is consistent with the existing pattern in cli.ts.

Add a test in docx-converter.test.ts that verifies: when fs.mkdir fails, the error has ErrorCodes.OUTPUT_DIR_FAILED (not DOCX_FAILED). Mock fs.mkdir to throw EACCES.
  </action>
  <verify>npx vitest run tests/converters/docx-converter.test.ts --reporter=verbose passes</verify>
  <done>DOCX mkdir failure throws OUTPUT_DIR_FAILED. Correct error code for directory creation problems.</done>
</task>

<task type="auto">
  <name>Task 3: Wrap addStyleTag() calls to prevent raw Puppeteer errors</name>
  <files>src/converters/pdf-converter.ts, tests/converters/pdf-converter.test.ts</files>
  <action>
In pdf-converter.ts, two bare `page.addStyleTag()` calls can leak raw Puppeteer errors:
- Line 146 in convertToPDF
- Line 281 in convertHTMLStringToPDF

If addStyleTag fails (e.g., page crashed, JavaScript execution failure), the raw error propagates instead of a ConversionError.

Wrap BOTH addStyleTag calls in try/catch:
```typescript
try {
  await page.addStyleTag({ content: `...` });
} catch (error) {
  throw createError(ErrorCodes.PDF_FAILED,
    `Failed to inject print CSS: ${error instanceof Error ? error.message : 'unknown error'}`
  );
}
```

Do NOT change the CSS content itself. Only add the try/catch wrapper around the existing addStyleTag calls in both convertToPDF and convertHTMLStringToPDF.

Add a test in pdf-converter.test.ts that verifies: when addStyleTag throws, a ConversionError with PDF_FAILED is thrown (not a raw Puppeteer error). Mock page.addStyleTag to throw.
  </action>
  <verify>npx vitest run tests/converters/pdf-converter.test.ts --reporter=verbose passes</verify>
  <done>Both addStyleTag calls wrapped in try/catch. Raw Puppeteer errors never reach users.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` - all tests pass (188+ tests)
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained (70% lines/functions/statements, 60% branches)
- [ ] check command: try/catch wraps entire action body
- [ ] DOCX converter: mkdir error uses OUTPUT_DIR_FAILED
- [ ] PDF converter: both addStyleTag calls wrapped in try/catch
</verification>

<success_criteria>

- All 3 error handling gaps fixed
- Regression tests added for each fix
- All existing tests still pass
- Coverage thresholds met
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-error-handling-gaps/25-01-SUMMARY.md`
</output>
