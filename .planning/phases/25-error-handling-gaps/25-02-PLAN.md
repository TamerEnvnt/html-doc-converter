---
phase: 25-error-handling-gaps
plan: 02
type: execute
---

<objective>
Fix 2 P2 safety gaps: platform silent fallback to linux without warning, and validateInputFile TOCTOU race between fs.access/fs.stat/fs.readFile.

Purpose: These gaps cause silent behavior changes on unusual platforms and a race condition that could produce confusing errors if a file is deleted mid-validation.
Output: Platform fallback logs a warning. validateInputFile uses single fs.readFile with ENOENT catch, eliminating 3-step TOCTOU.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/25-error-handling-gaps/25-01-SUMMARY.md

# Source files to modify:
@src/utils/platform.ts
@src/cli-helpers.ts

# Test files to extend:
@tests/utils/platform.test.ts
@tests/cli-helpers.test.ts

**Established patterns:**
- verbose() logger for debug-level information [Phase 10]
- Error cause chains: always pass { cause: error } when re-throwing [Phase 20]
- Atomic operations: prefer single fs call over multi-step check-then-act [Phase 20]
- INVALID_FORMAT used for non-HTML extension, INPUT_NOT_FOUND for missing files, EMPTY_INPUT for empty files [existing in cli-helpers.ts]

**Constraining decisions:**
- getPlatform() is used by soffice.ts for LibreOffice path detection - any change must keep the same return type
- validateInputFile returns { fileSize, content, isLargeFile } - the return type is used by cli.ts line 88
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add warning when platform falls back to linux</name>
  <files>src/utils/platform.ts, tests/utils/platform.test.ts</files>
  <action>
In platform.ts lines 22-28, `getPlatform()` silently returns 'linux' for unrecognized platforms. This could mask issues on exotic platforms (FreeBSD, Solaris, etc.).

Add a verbose() warning before the fallback:
1. Import verbose from '../utils/logger.js' at the top of the file (note: platform.ts is in utils/ so the import path is './logger.js')
2. Before `return 'linux'` on line 27, add: `verbose('Unknown platform:', p, '- falling back to linux');`

This is a WARNING-level message that only appears with --verbose flag, not a console.warn (which would always print). The verbose logger is the established pattern for debug information.

Do NOT change the return type or behavior - still return 'linux'. Just add the warning.

Add a test in platform.test.ts that verifies: when process.platform is an unrecognized value, getPlatform() returns 'linux' (this may already exist - check first). If a verbose warning test is feasible without excessive mocking, add it; otherwise the return value test is sufficient.
  </action>
  <verify>npx vitest run tests/utils/platform.test.ts --reporter=verbose passes</verify>
  <done>Unknown platform produces verbose warning. Return value unchanged (still 'linux' for compatibility).</done>
</task>

<task type="auto">
  <name>Task 2: Eliminate validateInputFile TOCTOU by collapsing to single fs.readFile</name>
  <files>src/cli-helpers.ts, tests/cli-helpers.test.ts</files>
  <action>
In cli-helpers.ts, `validateInputFile()` (lines 55-93) has a 3-step TOCTOU race:
1. `fs.access(inputPath)` - check exists
2. `fs.stat(inputPath)` - get size
3. `fs.readFile(inputPath)` - read content

Between any two steps, the file could be deleted, moved, or permissions changed.

Simplify to: check extension first (pure, no I/O), then single `fs.readFile()` with ENOENT error handling, then derive size from content.

Replace the function body with:
```typescript
const LARGE_FILE_THRESHOLD = 1_000_000; // 1MB

// 1. Check it's an HTML file (pure validation, no I/O)
const ext = path.extname(inputPath).toLowerCase();
if (ext !== '.html' && ext !== '.htm') {
  throw createError(ErrorCodes.INVALID_FORMAT, `expected .html or .htm, got ${ext}`);
}

// 2. Read file (single I/O operation - no TOCTOU)
let content: string;
try {
  content = await fs.readFile(inputPath, 'utf-8');
} catch (err) {
  if (err instanceof Error && 'code' in err && (err as NodeJS.ErrnoException).code === 'ENOENT') {
    throw createError(ErrorCodes.INPUT_NOT_FOUND, inputPath);
  }
  throw err; // Permission errors, etc. propagate as-is
}

// 3. Validate content
if (!content || !content.trim()) {
  throw createError(ErrorCodes.EMPTY_INPUT);
}

// 4. Derive size from content
const fileSize = Buffer.byteLength(content, 'utf-8');
const isLargeFile = fileSize > LARGE_FILE_THRESHOLD;

return { fileSize, content, isLargeFile };
```

Key changes:
- Extension check FIRST (pure, no I/O) - avoids reading non-HTML files
- Single `fs.readFile` replaces `fs.access` + `fs.stat` + `fs.readFile`
- ENOENT check on the single readFile maps to INPUT_NOT_FOUND
- `Buffer.byteLength` derives size from content (avoids separate stat)
- Empty file (0 bytes) and whitespace-only both caught by `!content || !content.trim()`

The return type is UNCHANGED: `{ fileSize, content, isLargeFile }`. cli.ts line 88 continues to work.

Note: fileSize is now derived from content bytes rather than fs.stat. For UTF-8 files this is equivalent. The minor behavior difference (stat reports disk allocation vs content bytes) is acceptable since fileSize is only used for the "large file" warning threshold.

Verify existing tests in cli-helpers.test.ts still pass. Add a test for the non-ENOENT error path (e.g., EACCES) to ensure it propagates correctly.
  </action>
  <verify>npx vitest run tests/cli-helpers.test.ts --reporter=verbose passes</verify>
  <done>validateInputFile uses single fs.readFile. TOCTOU eliminated. Extension validated before I/O. Return type unchanged.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` - all tests pass
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained
- [ ] Platform fallback: verbose warning logged for unknown platforms
- [ ] validateInputFile: single fs.readFile, no fs.access or fs.stat
- [ ] Return type of validateInputFile unchanged (fileSize, content, isLargeFile)
- [ ] Phase 25 complete (both plans done)
</verification>

<success_criteria>

- Both P2 gaps fixed
- Regression tests pass
- All existing tests still pass
- Coverage thresholds met
- Phase 25 fully complete
</success_criteria>

<output>
After completion, create `.planning/phases/25-error-handling-gaps/25-02-SUMMARY.md`
</output>
