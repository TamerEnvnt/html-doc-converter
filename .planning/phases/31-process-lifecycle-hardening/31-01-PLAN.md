---
phase: 31-process-lifecycle-hardening
plan: 01
type: execute
---

<objective>
Harden process lifecycle: move process.exit() after cleanup completes, add unhandledRejection handler.

Purpose: process.exit() inside try blocks kills the event loop before the finally block's async closeBrowser() can complete. Moving exit after cleanup ensures the browser process is always terminated. unhandledRejection prevents raw stack traces from leaking to users.
Output: Reliable cleanup ordering in both CLI commands, formatted error output for uncaught rejections.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/cli.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Move process.exit() after cleanup in both CLI commands</name>
  <files>src/cli.ts</files>
  <action>
  Refactor the main action handler (lines 73-250) and check command (lines 256-275) so process.exit() is called AFTER closeBrowser() completes, not before.

  **Main action handler (lines 73-250):**

  1. Add `let exitCode = 0;` before the try block (after createdFiles declaration, around line 82).

  2. In the try block, replace the process.exit() calls at lines 232-236:
     - Replace `process.exit(1);` with `exitCode = 1;`
     - Replace `process.exit(2);` with `exitCode = 2;`

  3. In the catch block, replace `process.exit(1);` at line 246 with `exitCode = 1;`

  4. In the finally block (line 247-249), call process.exit() AFTER closeBrowser():
     ```
     } finally {
       await closeBrowser();
       if (exitCode !== 0) {
         process.exit(exitCode);
       }
     }
     ```
     For exitCode 0 (full success), don't call process.exit() — let the process exit naturally when Commander's async action resolves. This avoids interfering with Node's natural shutdown.

  **Check command (lines 256-275):**

  Same pattern:
  1. Add `let exitCode = 0;` before try
  2. Replace `process.exit(result.allFound ? 0 : 1);` at line 264 with `exitCode = result.allFound ? 0 : 1;`
  3. Replace `process.exit(1);` at line 273 with `exitCode = 1;`
  4. Add finally block: `finally { if (exitCode !== 0) process.exit(exitCode); }`
     (No closeBrowser needed in check command — it doesn't launch a browser)

  Do NOT change the signal handlers (those already handle exit correctly via Phase 29).
  Do NOT change any conversion logic or error formatting.
  </action>
  <verify>npx tsc --noEmit && npx vitest run --reporter=verbose 2>&1 | tail -5</verify>
  <done>No process.exit() calls inside try/catch blocks. All exit calls happen after cleanup. Tests pass, no TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add unhandledRejection handler</name>
  <files>src/cli.ts</files>
  <action>
  Add a process.on('unhandledRejection') handler near the existing signal handlers (after line 298):

  ```
  process.on('unhandledRejection', (reason: unknown) => {
    console.error('');
    if (reason instanceof ConversionError) {
      console.error(formatError(reason));
    } else {
      console.error('Unexpected error:', reason instanceof Error ? reason.message : String(reason));
    }
    console.error('');
    process.exit(1);
  });
  ```

  This catches any unhandled promise rejections and formats them consistently with the CLI's error output, instead of letting Node.js print a raw stack trace.

  Place it between the signal handlers and `program.parse()`.
  Do NOT add unhandledRejection handler for the check command — the global handler covers both.
  </action>
  <verify>npx tsc --noEmit && npx vitest run --reporter=verbose 2>&1 | tail -5</verify>
  <done>process.on('unhandledRejection') handler exists. Formats errors consistently. Tests pass.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` — all tests pass
- [ ] `npx tsc --noEmit` — no TypeScript errors
- [ ] No process.exit() calls inside try or catch blocks (only in finally or after)
- [ ] unhandledRejection handler registered before program.parse()
</verification>

<success_criteria>
- 2 findings fixed in src/cli.ts
- closeBrowser() always runs before process.exit() in main action
- unhandledRejection produces formatted error output
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/31-process-lifecycle-hardening/31-01-SUMMARY.md`
</output>
