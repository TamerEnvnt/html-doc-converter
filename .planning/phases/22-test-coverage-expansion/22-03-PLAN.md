---
phase: 22-test-coverage-expansion
plan: 03
type: execute
---

<objective>
Improve CLI instrumented coverage by extracting testable validation logic from cli.ts into a helper module and adding unit tests.

Purpose: cli.ts is at 0% instrumented coverage because all tests run it as a subprocess via execFileSync. Extracting key logic into an importable module allows vitest to instrument and cover those lines.
Output: New src/cli-helpers.ts with extracted functions, updated cli.ts to use them, and tests/cli-helpers.test.ts with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files:
@src/cli.ts
@tests/cli.test.ts

**Tech stack available:** vitest, commander
**Established patterns:**
- expect.assertions guard on try/catch tests (Phase 21)
- ConversionError with ErrorCodes (Phase 17)

**Constraining decisions:**
- Phase 17: CLI uses createError/formatError for all error reporting
- Phase 20: Timeout validation throws INVALID_TIMEOUT
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract testable logic from cli.ts into cli-helpers.ts</name>
  <files>src/cli-helpers.ts, src/cli.ts</files>
  <action>
Create `src/cli-helpers.ts` with these functions extracted from cli.ts's action handler:

1. **`determineFormats(options: { pdfOnly?: boolean; docxOnly?: boolean; format?: string }): { generatePDF: boolean; generateDOCX: boolean }`**
   - Lines 138-145 of cli.ts: the format flag logic
   - Returns which formats to generate based on CLI options

2. **`parseTimeout(timeoutStr: string | undefined): number`**
   - Lines 186-190 of cli.ts: timeout parsing and validation
   - Returns validated timeout number
   - Throws ConversionError(INVALID_TIMEOUT) for NaN, <=0, or undefined

3. **`validateInputFile(inputPath: string): Promise<{ fileSize: number; content: string; isLargeFile: boolean }>`**
   - Lines 87-116 of cli.ts: existence check, extension check, size check, content check
   - Throws INPUT_NOT_FOUND, INVALID_FORMAT, EMPTY_INPUT as appropriate
   - Returns file metadata for the caller

Update cli.ts to import and use these functions instead of inline logic. The behavior must be identical - this is a pure refactor.

Important: Do NOT change any CLI behavior. Keep the same error messages, same codes, same flow. Only move logic to separate functions.
  </action>
  <verify>cd /Users/tamer/Work/AI/Claude/html-doc-converter && npm run build && npx vitest run tests/cli.test.ts</verify>
  <done>cli-helpers.ts created with 3 exported functions. cli.ts updated to use them. Build passes. Existing CLI tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for cli-helpers.ts</name>
  <files>tests/cli-helpers.test.ts</files>
  <action>
Create `tests/cli-helpers.test.ts` with deterministic unit tests:

**determineFormats tests:**
1. Default (no flags) → both true
2. pdfOnly → PDF true, DOCX false
3. docxOnly → PDF false, DOCX true
4. format: 'pdf' → PDF true, DOCX false
5. format: 'docx' → PDF false, DOCX true
6. format: 'both' → both true
7. pdfOnly takes precedence over format

**parseTimeout tests:**
1. Valid string '30000' → returns 30000
2. Default undefined → returns 60000 (or throw - check cli.ts behavior)
3. Non-numeric 'abc' → throws ConversionError INVALID_TIMEOUT
4. Zero '0' → throws ConversionError INVALID_TIMEOUT
5. Negative '-5000' → throws ConversionError INVALID_TIMEOUT
6. Float '30000.5' → returns 30000 (parseInt truncates)

**validateInputFile tests (mock fs):**
1. File not found → throws INPUT_NOT_FOUND
2. Non-HTML extension (.txt) → throws INVALID_FORMAT
3. Empty file (0 bytes) → throws EMPTY_INPUT
4. Whitespace-only content → throws EMPTY_INPUT
5. Valid HTML file → returns { fileSize, content, isLargeFile: false }
6. Large file (>1MB) → returns { isLargeFile: true }

Use vi.mock('fs/promises') for validateInputFile tests. Use expect.assertions(1) on all catch-based tests.
  </action>
  <verify>cd /Users/tamer/Work/AI/Claude/html-doc-converter && npx vitest run tests/cli-helpers.test.ts</verify>
  <done>18+ tests across 3 describe blocks, all passing</done>
</task>

<task type="auto">
  <name>Task 3: Verify coverage improvement and run full suite</name>
  <files>vitest.config.ts</files>
  <action>
Run the full test suite with coverage to verify improvement:

```bash
npx vitest run --coverage
```

Check that:
1. cli-helpers.ts shows high coverage (should be 90%+)
2. Overall statement/function coverage hasn't dropped
3. All 141+ existing tests still pass
4. No regressions introduced

If coverage thresholds in vitest.config.ts need updating (currently lines: 70, functions: 70, branches: 60, statements: 70), leave them as-is - they should be met or exceeded.

Do NOT modify vitest.config.ts unless coverage check fails due to a threshold issue.
  </action>
  <verify>cd /Users/tamer/Work/AI/Claude/html-doc-converter && npx vitest run --coverage 2>&1 | tail -30</verify>
  <done>Full suite passes. cli-helpers.ts has 90%+ coverage. Overall thresholds met.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx vitest run` - full suite passes (existing + new tests)
- [ ] `npx vitest run --coverage` - thresholds met
- [ ] cli-helpers.ts is well-covered by unit tests
- [ ] CLI behavior unchanged (existing subprocess tests prove this)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CLI has testable extracted logic with unit tests
- No behavioral changes to CLI
- Phase 22 complete (all 3 plans)
  </success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage-expansion/22-03-SUMMARY.md`
</output>
