---
phase: 22-test-coverage-expansion
plan: 02
type: execute
---

<objective>
Add deterministic mocked tests for DOCX converter public API functions: convertToDOCX (success paths and specific error paths) and convertHTMLFileToDOCX (success path).

Purpose: Current DOCX tests are environment-dependent (try/catch based on LibreOffice presence). Need deterministic mocked tests that exercise success paths, error handling, and return shapes regardless of environment.
Output: Expanded docx-converter.test.ts with mocked tests covering LibreOffice execution, output verification, rename handling, and error cases.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-test-defect-fixes/21-01-SUMMARY.md

# Key source files:
@src/converters/docx-converter.ts
@tests/docx-converter.test.ts
@src/utils/soffice.ts

**Tech stack available:** vitest
**Established patterns:**
- expect.assertions guard on try/catch tests (Phase 21)
- Behavioral testing (Phase 21)

**Constraining decisions:**
- Phase 17: convertToDOCX throws ConversionError (LIBREOFFICE_MISSING or DOCX_FAILED), returns {outputPath: string}
- Phase 20: findSoffice properly handles EACCES
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mocked convertToDOCX tests</name>
  <files>tests/docx-converter.test.ts</files>
  <action>
Add a new `describe('convertToDOCX - mocked')` block. Use vi.mock to mock dependencies:

**Mocks needed:**
- `vi.mock('../src/utils/soffice.js')` - mock findSoffice to return '/usr/bin/soffice'
- `vi.mock('child_process')` - mock execFile to call callback with success (no error, stdout, stderr)
- `vi.mock('fs/promises')` - mock fs.mkdir, fs.access, fs.rename

**Tests to add:**
1. **Success path (same output dir)**: findSoffice returns path. execFile succeeds. fs.access succeeds (output file exists). generatedPath === outputPath (no rename needed). Assert result is `{outputPath: expected}`.
2. **Success path (different output name)**: outputPath differs from generated name. fs.rename succeeds. Assert result has correct outputPath.
3. **LibreOffice not found**: findSoffice returns null. expect.assertions(1). Assert throws ConversionError with code LIBREOFFICE_MISSING.
4. **LibreOffice execution fails**: execFile rejects with error. Assert throws ConversionError with code DOCX_FAILED.
5. **Output file missing after conversion**: execFile succeeds but fs.access throws (output not created). Assert throws ConversionError with DOCX_FAILED and message containing 'output file not found'.
6. **Rename failure**: fs.rename rejects. Assert throws ConversionError with DOCX_FAILED and message containing 'rename'.

Important: Use vi.mocked() and mockResolvedValue/mockRejectedValue for clean mock setup. Reset mocks in beforeEach. The existing tests in the file use real imports - keep them in a separate describe block so they continue working.
  </action>
  <verify>cd /Users/tamer/Work/AI/Claude/html-doc-converter && npx vitest run tests/docx-converter.test.ts</verify>
  <done>6 new mocked tests, all passing. Existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add mocked convertHTMLFileToDOCX tests</name>
  <files>tests/docx-converter.test.ts</files>
  <action>
Add a `describe('convertHTMLFileToDOCX - mocked')` block.

**Additional mock:** `vi.mock('../src/parsers/html-parser.js')` - mock parseDocument to return a fake ParsedDocument object: `{ title: 'Test', chapters: [], metadata: { title: 'Test' } }`.

**Tests to add:**
1. **Success path**: parseDocument returns fake doc. convertToDOCX succeeds (via existing mocks from Task 1). Assert result has both `document` (matching fake ParsedDocument) and `docx` (with outputPath).
2. **Parse error propagation**: parseDocument rejects. Assert error propagates (not swallowed).
3. **Conversion error propagation**: parseDocument succeeds but convertToDOCX fails (findSoffice returns null). Assert ConversionError propagates.

Important: The mock for html-parser must coexist with the soffice and fs mocks from Task 1. Use beforeEach to set up default mock return values, override per-test as needed.
  </action>
  <verify>cd /Users/tamer/Work/AI/Claude/html-doc-converter && npx vitest run tests/docx-converter.test.ts</verify>
  <done>3 new mocked tests, all passing. Total docx-converter.test.ts: 12+ tests.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run tests/docx-converter.test.ts` - all tests pass
- [ ] `npx vitest run` - full suite still passes (no regressions)
- [ ] convertToDOCX has mocked tests for: success (same dir, rename), LibreOffice missing, exec failure, output missing, rename failure
- [ ] convertHTMLFileToDOCX has mocked tests for: success shape, parse error, conversion error
</verification>

<success_criteria>

- All new tests pass
- No regressions in existing test suite
- DOCX converter tests are fully deterministic (no LibreOffice dependency)
- All error paths from Phase 17 refactoring are tested
  </success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage-expansion/22-02-SUMMARY.md`
</output>
