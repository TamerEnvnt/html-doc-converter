---
phase: 33-api-performance-cleanup
plan: 01
type: execute
---

<objective>
Clean up public API surface, extract timeout constants, fix O(n^2) string concatenation, and add scale NaN validation.

Purpose: getBrowser() leaks internal singleton management. Magic numbers make timeouts hard to change. String concatenation in a loop is O(n^2) for large documents. NaN bypasses scale range validation.
Output: Tighter public API, centralized timeout constants, array-join pattern for content extraction, complete scale validation.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/index.ts
@src/converters/pdf-converter.ts
@src/parsers/html-parser.ts
@src/converters/docx-converter.ts
@src/cli-helpers.ts
@src/cli.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Remove getBrowser() from API, fix scale NaN, fix O(n^2) string concat</name>
  <files>src/index.ts, src/converters/pdf-converter.ts, src/parsers/html-parser.ts</files>
  <action>
  **index.ts — Remove getBrowser() from public API (line 12):**

  Remove `getBrowser` from the export list. Keep `closeBrowser` — consumers legitimately need this for cleanup. The export block should become:

  ```
  export {
    convertToPDF,
    convertHTMLFileToPDF,
    convertHTMLStringToPDF,
    closeBrowser,
  } from './converters/pdf-converter.js';
  ```

  Do NOT change any other exports. Do NOT remove getBrowser from pdf-converter.ts itself (it's still used internally and by cli.ts).

  **pdf-converter.ts — Add NaN to scale validation (line 127):**

  Current: `if (options.scale !== undefined && (options.scale < 0.1 || options.scale > 2))`
  Problem: `NaN < 0.1` is `false`, `NaN > 2` is `false`, so NaN passes.

  Fix — add `isNaN` check:
  ```
  if (options.scale !== undefined && (isNaN(options.scale) || options.scale < 0.1 || options.scale > 2)) {
  ```

  This ensures NaN is caught at the validation boundary. The downstream `options.scale || 1` would catch NaN anyway (NaN is falsy), but explicit validation is cleaner.

  Do NOT change anything else in pdf-converter.ts (timeout constants will be handled in Task 2).

  **html-parser.ts — Fix O(n^2) string concatenation (lines 106-112):**

  Replace the content accumulation loop with array-join pattern:

  Before:
  ```
  let content = '';
  const $el = doc(element);
  let $next = $el.next();
  while ($next.length > 0 && !$next.is('h1, h2, h3, h4, h5, h6')) {
    content += doc.html($next) || '';
    $next = $next.next();
  }
  ```

  After:
  ```
  const contentParts: string[] = [];
  const $el = doc(element);
  let $next = $el.next();
  while ($next.length > 0 && !$next.is('h1, h2, h3, h4, h5, h6')) {
    const html = doc.html($next);
    if (html) {
      contentParts.push(html);
    }
    $next = $next.next();
  }
  ```

  Then update line 118 to use `contentParts.join('')` instead of `content`:
  ```
  const chapter: Chapter = {
    id,
    title,
    level,
    content: contentParts.join('').trim(),
    children: [],
  };
  ```

  This changes string concatenation from O(n^2) to O(n) by collecting parts in an array and joining once.
  </action>
  <verify>npx tsc --noEmit && npx vitest run tests/html-parser.test.ts tests/pdf-converter.test.ts --reporter=verbose 2>&1 | tail -10</verify>
  <done>getBrowser not in index.ts exports. Scale validation catches NaN. Chapter content uses array-join. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Extract timeout constants to centralized module</name>
  <files>src/utils/constants.ts (new), src/converters/pdf-converter.ts, src/converters/docx-converter.ts, src/cli-helpers.ts, src/cli.ts</files>
  <action>
  **Create src/utils/constants.ts:**

  ```typescript
  /**
   * Shared Constants
   *
   * Centralized timeout and configuration values used across modules.
   */

  /** Default conversion timeout in milliseconds (used for PDF navigation, PDF generation, DOCX conversion) */
  export const DEFAULT_TIMEOUT_MS = 60000;

  /** Browser launch timeout in milliseconds (Puppeteer-specific) */
  export const BROWSER_LAUNCH_TIMEOUT_MS = 30000;
  ```

  **Update src/converters/pdf-converter.ts:**

  1. Add import: `import { DEFAULT_TIMEOUT_MS, BROWSER_LAUNCH_TIMEOUT_MS } from '../utils/constants.js';`

  2. Replace browser launch timeout (line 68):
     `timeout: 30000,` → `timeout: BROWSER_LAUNCH_TIMEOUT_MS,`

  3. Replace browser launch error message (line 86):
     `'Browser launch timed out after 30000ms'` → `` `Browser launch timed out after ${BROWSER_LAUNCH_TIMEOUT_MS}ms` ``

  4. Replace all 4 occurrences of `?? 60000` with `?? DEFAULT_TIMEOUT_MS`:
     - Line 195: `options.timeout ?? 60000` → `options.timeout ?? DEFAULT_TIMEOUT_MS`
     - Line 262: same
     - Line 311: same
     - Line 356: same

  **Update src/converters/docx-converter.ts:**

  1. Add import: `import { DEFAULT_TIMEOUT_MS } from '../utils/constants.js';`
  2. Line 78: `options.timeout ?? 60000` → `options.timeout ?? DEFAULT_TIMEOUT_MS`

  **Update src/cli-helpers.ts:**

  1. Add import: `import { DEFAULT_TIMEOUT_MS } from './utils/constants.js';`
  2. Line 44: `parseInt(timeoutStr || '60000', 10)` → `parseInt(timeoutStr || String(DEFAULT_TIMEOUT_MS), 10)`

  **Update src/cli.ts:**

  1. Add import: `import { DEFAULT_TIMEOUT_MS } from './utils/constants.js';`
  2. Line 59: `.option('-t, --timeout <ms>', 'Conversion timeout in milliseconds', '60000')` → `.option('-t, --timeout <ms>', 'Conversion timeout in milliseconds', String(DEFAULT_TIMEOUT_MS))`

  Do NOT change any other code. This is a pure extract-constant refactoring — behavior must be identical.
  </action>
  <verify>npx tsc --noEmit && npx vitest run --reporter=verbose 2>&1 | tail -5</verify>
  <done>No magic number 60000 or 30000 in source files (except constants.ts). All tests pass. TypeScript clean.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` — all tests pass
- [ ] `npx tsc --noEmit` — no TypeScript errors
- [ ] `grep -rn '60000' src/ --include='*.ts'` shows only constants.ts and possibly string references in error messages
- [ ] `grep -rn '30000' src/ --include='*.ts'` shows only constants.ts
- [ ] getBrowser not exported from src/index.ts
- [ ] Scale NaN validation catches NaN
</verification>

<success_criteria>
- 4 findings addressed across 6 files (1 new, 5 modified)
- Public API surface reduced (getBrowser removed)
- All timeout magic numbers centralized
- O(n^2) string concatenation fixed to O(n)
- Scale validation catches NaN
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-api-performance-cleanup/33-01-SUMMARY.md`
</output>
