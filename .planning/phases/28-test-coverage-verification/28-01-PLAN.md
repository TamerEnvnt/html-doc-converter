---
phase: 28-test-coverage-verification
plan: 01
type: execute
---

<objective>
Fill P1 test coverage gaps: soffice.ts (28.57% branch), pdf-converter non-timeout error rethrow, docx-converter non-Error throw, html-parser non-ENOENT error.
Purpose: Address 4 P1 test findings from post-v1.2 codebase review.
Output: New soffice.test.ts + additions to existing test files. All 4 P1 gaps covered.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/utils/soffice.ts
@src/converters/pdf-converter.ts
@src/converters/docx-converter.ts
@src/parsers/html-parser.ts
@tests/pdf-converter.test.ts
@tests/docx-converter-mocked.test.ts
@tests/html-parser.test.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: soffice.ts EACCES path + which/where fallback tests</name>
  <files>tests/utils/soffice.test.ts (CREATE)</files>
  <action>
Create new test file `tests/utils/soffice.test.ts` for `findSoffice()` and `verifyLibreOffice()`.

Mock `fs/promises` and `../src/utils/exec.js` (execFileAsync). Mock `../src/utils/platform.js` to control getPlatform return value.

Tests to write:
1. **EACCES error path** (soffice.ts lines 47-48): Mock fs.access to throw with code 'EACCES' for the first path. Assert findSoffice() throws Error with message containing "lacks execute permission".
2. **ENOENT continues to next path** (lines 50-51): Mock fs.access to throw ENOENT for first path, succeed for second. Assert returns second path.
3. **which/where fallback success** (lines 56-59): Mock fs.access to throw ENOENT for ALL known paths. Mock execFileAsync to resolve with `{ stdout: '/usr/local/bin/soffice\n' }`. Assert returns '/usr/local/bin/soffice'.
4. **which/where fallback failure returns null** (lines 60-61): Mock fs.access to throw ENOENT for all paths. Mock execFileAsync to reject. Assert returns null.
5. **win32 uses 'where' binary** (line 57): Mock getPlatform to return 'win32'. Mock fs.access to throw ENOENT for all win32 paths. Mock execFileAsync. Assert execFileAsync called with 'where' (not 'which').
6. **verifyLibreOffice delegates to findSoffice** (line 70-71): Test returns true when findSoffice finds a path, false when null.

Follow mocking pattern from `tests/docx-converter-mocked.test.ts`: vi.mock at top, import after, vi.mocked() for type-safe access.

Important: Mock `../src/utils/platform.js` returning `{ getPlatform: vi.fn(), getPlatformName: vi.fn() }`. Default getPlatform to 'darwin'.
  </action>
  <verify>npx vitest run tests/utils/soffice.test.ts -- all tests pass</verify>
  <done>6+ tests covering EACCES throw, ENOENT continue, which/where fallback (success + failure), win32 'where' binary, verifyLibreOffice.</done>
</task>

<task type="auto">
  <name>Task 2: pdf-converter non-timeout error rethrow tests</name>
  <files>tests/pdf-converter.test.ts (MODIFY)</files>
  <action>
Add tests for non-timeout error rethrow in `convertToPDF` (line 200) and `convertHTMLStringToPDF` (line 313).

In `tests/pdf-converter.test.ts`, these paths are triggered when page.goto() or page.setContent() throws a non-timeout error (i.e., error.name !== 'TimeoutError' and message doesn't include 'timeout'). The existing test file already mocks puppeteer and has `createMockPage()`.

Tests to add (inside existing describe blocks):

1. **convertToPDF: non-timeout goto error re-thrown** (line 200):
   In the `convertToPDF` describe block, add test: mock page.goto to reject with `new Error('net::ERR_FILE_NOT_FOUND')`. Assert convertToPDF rejects with error message containing 'ERR_FILE_NOT_FOUND'. Should NOT be a ConversionError (raw error propagates).

2. **convertHTMLStringToPDF: non-timeout setContent error re-thrown** (line 313):
   In the `convertHTMLStringToPDF` describe block, add test: mock page.setContent to reject with `new Error('Invalid HTML content')`. Assert convertHTMLStringToPDF rejects with error message containing 'Invalid HTML content'. Should NOT be a ConversionError.

Follow existing test patterns: get mock page via `(await puppeteer.launch()).newPage()`, configure the mock, call the function, assert rejection.

Make sure to use beforeEach closeBrowser + clearAllMocks pattern already in the file.
  </action>
  <verify>npx vitest run tests/pdf-converter.test.ts -- all tests pass including new ones</verify>
  <done>2 new tests: goto non-timeout error rethrow, setContent non-timeout error rethrow. Lines 200-201, 313-314 covered.</done>
</task>

<task type="auto">
  <name>Task 3: docx-converter non-Error throw + html-parser non-ENOENT error</name>
  <files>tests/docx-converter-mocked.test.ts (MODIFY), tests/html-parser.test.ts (MODIFY)</files>
  <action>
**Part A: docx-converter non-Error throw** (docx-converter.ts line 105)

In `tests/docx-converter-mocked.test.ts`, add test for when the conversion subprocess rejects with a non-Error value (string). The code at line 105 does `String(error)` for non-Error throws.

The current mock setup in docx-converter-mocked.test.ts mocks `child_process` with execFile. For this test, configure the mock to invoke its callback with a string as the first argument (error position): `cb('string-error-from-process')`. Since docx-converter.ts uses `execFileAsync` from `src/utils/exec.js` (which wraps promisify of execFile), the rejection will propagate as a non-Error value.

Assert that convertToDOCX throws ConversionError with code DOCX_FAILED and message containing 'string-error-from-process'.

**Part B: html-parser non-ENOENT error** (html-parser.ts lines 53-54)

In `tests/html-parser.test.ts`, add a test for loadHTML when readFile throws a non-ENOENT error (e.g., EACCES permission denied).

Import `loadHTML` from the parser. Use `vi.spyOn` on the `fs/promises` module's `readFile` to mock a rejection with an error having `code: 'EACCES'`. Assert loadHTML throws Error with message containing 'Failed to load HTML file'. Restore the spy after the test.

The `vi.spyOn` approach avoids file-scoped vi.mock conflicts with the existing integration-style tests in html-parser.test.ts.
  </action>
  <verify>npx vitest run tests/docx-converter-mocked.test.ts tests/html-parser.test.ts -- all tests pass</verify>
  <done>1 test for non-Error throw in docx-converter (line 105 covered). 1 test for non-ENOENT error in html-parser (lines 53-54 covered).</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` passes all tests (existing + new)
- [ ] New soffice.test.ts has 6+ passing tests
- [ ] pdf-converter.test.ts has 2 new non-timeout error rethrow tests
- [ ] docx-converter-mocked.test.ts has 1 new non-Error throw test
- [ ] html-parser.test.ts has 1 new non-ENOENT error test
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All 4 P1 test gaps addressed with targeted tests
- soffice.ts branch coverage significantly improved from 28.57%
- pdf-converter lines 200-201, 313-314 covered
- docx-converter line 105 covered
- html-parser lines 53-54 covered
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-test-coverage-verification/28-01-SUMMARY.md`:

# Plan 28-01: P1 Test Coverage Gaps -- Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Test Results

## Issues Encountered

## Next Plan Readiness
</output>
