---
phase: 28-test-coverage-verification
plan: 02
type: execute
---

<objective>
Fill P2 test coverage gaps and run final verification: platform.ts getPlatformName branches, dependencies.ts optional dep formatting, final coverage threshold check.
Purpose: Address remaining P2 test findings and verify milestone v1.3 readiness.
Output: Additions to existing test files. Coverage report confirms thresholds met.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/utils/platform.ts
@src/utils/dependencies.ts
@tests/utils/platform.test.ts
@tests/utils/dependencies.test.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: platform.ts getPlatformName branches + dependencies.ts optional dep format</name>
  <files>tests/utils/platform.test.ts (MODIFY), tests/utils/dependencies.test.ts (MODIFY)</files>
  <action>
**Part A: platform.ts getPlatformName for non-current platforms** (lines 43, 45, 47)

In `tests/utils/platform.test.ts`, add tests for `getPlatformName()` covering all 3 switch cases:
1. Test getPlatformName returns 'macOS' when platform is 'darwin'
2. Test getPlatformName returns 'Windows' when platform is 'win32'
3. Test getPlatformName returns 'Linux' when platform is 'linux'

Since getPlatformName() calls getPlatform() internally, use vi.mock on `../src/utils/platform.js` or vi.spyOn on process.platform to control the return value. However, since getPlatform uses `process.platform`, the simplest approach is:
- Import both getPlatform and getPlatformName
- For non-current platform tests, mock the module: create a separate test group that uses vi.mock
- OR: test only the current platform directly and use vi.spyOn on the module

Actually, since platform.ts exports `getPlatform()` which reads `process.platform`, and `getPlatformName()` calls `getPlatform()`:
- Use `vi.spyOn` on the module to mock getPlatform's return value, then call getPlatformName

Simplest approach: The test file currently imports from platform.js. Add tests that:
- Mock `process.platform` using `Object.defineProperty(process, 'platform', { value: 'win32' })` and restore after
- Call getPlatformName() and assert result

Be careful to restore process.platform after each test to avoid polluting other tests.

**Part B: dependencies.ts formatDependencyReport with optional dep** (line 182)

In `tests/utils/dependencies.test.ts`, add a test for `formatDependencyReport` with a dependency where `required: false`. This covers line 182 (the `(optional)` label branch).

Test: Create a DependencyCheckResult with one dependency having `required: false, found: true, path: '/test'`. Assert the report contains '(optional)' text.

Also add test for found dependency without version (line 138 branch is the catch block â€” already tested via existing "shows found dep without version" test, but confirm version detection failure path is covered).
  </action>
  <verify>npx vitest run tests/utils/platform.test.ts tests/utils/dependencies.test.ts -- all tests pass</verify>
  <done>3 getPlatformName tests (darwin/win32/linux). 1 optional dep formatting test. Lines 43, 45, 47, 182 covered.</done>
</task>

<task type="auto">
  <name>Task 2: Final coverage verification and threshold check</name>
  <files>none (verification only)</files>
  <action>
Run full test suite with coverage:
```
npx vitest run --coverage
```

Verify:
1. All tests pass (existing + new from 28-01 and 28-02)
2. Coverage thresholds met: 70% lines/functions/statements, 60% branches
3. Report total test count (should be ~185+)
4. Note any remaining uncovered lines for documentation in SUMMARY.md

Key coverage improvements to verify:
- soffice.ts: branch coverage should be significantly above 28.57%
- pdf-converter.ts: lines 200-201, 313-314 should now be covered
- docx-converter.ts: line 105 should now be covered
- html-parser.ts: lines 53-54 should now be covered
- platform.ts: lines 43, 45, 47 should now be covered

Record the final coverage numbers in SUMMARY.md for milestone v1.3 record.
  </action>
  <verify>npx vitest run --coverage -- all pass, all thresholds met</verify>
  <done>Full test suite passes. Coverage thresholds met. Final numbers documented.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run --coverage` passes all tests
- [ ] Coverage thresholds met (70% stmts/lines/funcs, 60% branches)
- [ ] soffice.ts branch coverage improved significantly
- [ ] No regressions in existing tests
</verification>

<success_criteria>
- All P2 test gaps addressed
- Full test suite passes
- Coverage thresholds confirmed met
- Final coverage report documented for milestone record
</success_criteria>

<output>
After completion, create `.planning/phases/28-test-coverage-verification/28-02-SUMMARY.md`:

# Plan 28-02: P2 Test Coverage + Verification -- Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Test Results

## Coverage Report

## Milestone v1.3 Readiness
</output>
