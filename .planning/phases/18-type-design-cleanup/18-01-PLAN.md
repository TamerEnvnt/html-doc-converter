---
phase: 18-type-design-cleanup
plan: 01
type: execute
---

<objective>
Remove dead type fields, fix unsafe Platform cast, and add HeadingLevel type for better type safety across the codebase.

Purpose: Eliminate invalid states that types currently allow. Dead fields mislead consumers, the unsafe Platform cast silently accepts unsupported platforms, and Chapter.level accepts any number when only 1-6 are valid.
Output: Tighter types across 5 files, no dead fields, safer platform handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase (directly affects this one):
@.planning/phases/17-error-handling-unification/17-01-SUMMARY.md
(After 17-01: DOCXResult is { outputPath: string } - success/error fields already removed)

# Source files:
@src/converters/pdf-converter.ts (lines 34-36: PDFResult with dead pageCount)
@src/converters/docx-converter.ts (line 22: DOCXOptions with dead preserveStyles)
@src/utils/dependencies.ts (lines 21-28: DependencyStatus boolean+optional pattern)
@src/utils/platform.ts (line 23: unsafe `process.platform as Platform` cast)
@src/parsers/html-parser.ts (line 15: Chapter.level typed as number)

# Tests that reference these types:
@tests/utils/dependencies.test.ts (imports DependencyStatus)
@tests/html-parser.test.ts (uses chapter.level with numeric values 1, 2)

**Constraining decisions:**
- Phase 17: DOCXResult already simplified to { outputPath: string }
- Phase 17: Throw-on-failure pattern established (converters throw, callers try/catch)

**Findings addressed:**
- PDFResult.pageCount never populated (dead field)
- DOCXOptions.preserveStyles never read (dead field)
- DependencyStatus boolean+optional anti-pattern (found:boolean + path?:string)
- Platform unsafe cast (process.platform as Platform silently accepts FreeBSD etc.)
- Chapter.level typed as number instead of 1|2|3|4|5|6
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove dead type fields and add HeadingLevel</name>
  <files>src/converters/pdf-converter.ts, src/converters/docx-converter.ts, src/parsers/html-parser.ts</files>
  <action>
**In pdf-converter.ts (lines 34-36):**
Remove `pageCount?: number` from PDFResult. It's never populated anywhere in the code. New shape:
```
export interface PDFResult {
  buffer: Buffer;
}
```

**In docx-converter.ts (line 22):**
Remove `preserveStyles?: boolean` from DOCXOptions. It's never read by convertToDOCX. New shape:
```
export interface DOCXOptions {
  outputDir?: string;
  timeout?: number;
}
```

**In html-parser.ts (line 15):**
1. Add a HeadingLevel type above the Chapter interface:
   `export type HeadingLevel = 1 | 2 | 3 | 4 | 5 | 6;`

2. Change `level: number` to `level: HeadingLevel` in the Chapter interface.

3. In extractChapters (line 80), the `parseInt(tagName.charAt(1), 10)` returns `number`. Cast it:
   `const level = parseInt(tagName.charAt(1), 10) as HeadingLevel;`
   This cast is safe because we only parse h1-h6 tags (the selector on line 77 guarantees this).

**What to avoid:**
- Do NOT remove DOCXOptions.outputDir or DOCXOptions.timeout - those are used.
- Do NOT add pageCount back with a real implementation - that's scope creep (Phase 22+ if wanted).
- Do NOT change function signatures, only type definitions.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
`npm run typecheck` passes.
  </verify>
  <done>
- PDFResult has no pageCount field
- DOCXOptions has no preserveStyles field
- Chapter.level is typed as HeadingLevel (1|2|3|4|5|6)
- HeadingLevel exported from html-parser.ts
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Platform unsafe cast and DependencyStatus anti-pattern</name>
  <files>src/utils/platform.ts, src/utils/dependencies.ts, tests/utils/dependencies.test.ts</files>
  <action>
**In platform.ts (line 22-24):**

The current `getPlatform()` does `process.platform as Platform` which silently accepts FreeBSD, AIX, etc. Fix:

```typescript
export function getPlatform(): Platform {
  const p = process.platform;
  if (p === 'darwin' || p === 'linux' || p === 'win32') {
    return p;
  }
  // Fallback for unsupported platforms - treat as linux (closest to most Unix-like systems)
  return 'linux';
}
```

This is a narrowing approach instead of a widening cast. The fallback to 'linux' is intentional: unsupported Unix-like platforms (FreeBSD, SunOS) are closer to Linux than any other option.

**In dependencies.ts (lines 21-28):**

The DependencyStatus interface uses the `found: boolean` + `path?: string` + `version?: string` anti-pattern where `found: false` but `path` could still be set (invalid state). However, changing this to a discriminated union would require updating ALL consumers (checkChromium, checkLibreOffice, formatDependencyReport, tests).

**Assessment:** The current shape is used consistently throughout the module. Converting to a discriminated union is a moderate refactor with low value - the boolean+optional pattern is idiomatic for status objects in this context. The review finding rated this P2.

**Decision:** Skip the DependencyStatus refactor. It's not worth the churn for a P2 finding on an internal-only type. Log reasoning in summary.

**In tests/utils/dependencies.test.ts:**
No changes needed - DependencyStatus import is `import type` only, compatible with any shape change. If we had changed the interface, verify tests still compile.

**What to avoid:**
- Do NOT throw on unsupported platforms - that would break the tool on FreeBSD. Fall back gracefully.
- Do NOT change the DependencyStatus interface (deferred - low value).
- Do NOT change checkChromium/checkLibreOffice implementations.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
`npm test` passes all tests.
  </verify>
  <done>
- getPlatform() uses type narrowing instead of unsafe cast
- Unsupported platforms fall back to 'linux' instead of silently casting
- Build passes
- All tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] `npm run typecheck` passes
- [ ] PDFResult has no pageCount field
- [ ] DOCXOptions has no preserveStyles field
- [ ] Chapter.level typed as HeadingLevel (1|2|3|4|5|6)
- [ ] getPlatform() uses narrowing, not unsafe cast
- [ ] HeadingLevel is exported from html-parser.ts
</verification>

<success_criteria>

- Dead fields removed (PDFResult.pageCount, DOCXOptions.preserveStyles)
- HeadingLevel type added and used for Chapter.level
- Platform cast fixed with type narrowing
- DependencyStatus deferred (documented reasoning)
- All tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/18-type-design-cleanup/18-01-SUMMARY.md`
</output>
