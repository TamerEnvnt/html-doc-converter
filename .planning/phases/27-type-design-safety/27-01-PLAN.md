---
phase: 27-type-design-safety
plan: 01
type: execute
---

<objective>
Fix 2 P1 type safety issues: DependencyStatus discriminated union to eliminate invalid states, PDFOptions library-level validation for scale/timeout.

Purpose: Prevent runtime invalid states through TypeScript's type system. Library consumers get compile-time guarantees and meaningful validation errors.
Output: DependencyStatus as discriminated union. PDFOptions validated at library boundary.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
None (first plan)

# Source files to modify:
@src/utils/dependencies.ts
@src/converters/pdf-converter.ts

# Test files to modify:
@tests/utils/dependencies.test.ts
@tests/pdf-converter.test.ts

**Established patterns:**
- Throw-on-failure: converters throw ConversionError, callers use try/catch [Phase 17]
- TypeScript never type for exhaustive switch enforcement [Phase 23]
- Internal helper extraction for module-level deduplication [Phase 26]

**Constraining decisions:**
- Phase 18 deferred DependencyStatus refactor as P2 — now elevated to P1 by post-v1.2 review
- DependencyStatus is NOT in index.ts public API — internal type only
- PDFOptions IS exported via index.ts — validation changes affect public API consumers
- buildPdfOptions is an internal helper (Phase 26) — validation goes there

**Key verification:**
- `DependencyStatus` is imported as `import type` in tests — union type change is compatible
- `formatDependencyReport` uses `if (dep.found)` which naturally narrows a discriminated union
- `buildPdfOptions` is called by both convertToPDF and convertHTMLStringToPDF — validation applies to all paths
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert DependencyStatus to discriminated union</name>
  <files>src/utils/dependencies.ts, tests/utils/dependencies.test.ts</files>
  <action>
In dependencies.ts, replace the current DependencyStatus interface (lines 19-26) with a discriminated union:

```typescript
interface DependencyBase {
  readonly name: string;
  readonly required: boolean;
}

export interface FoundDependency extends DependencyBase {
  readonly found: true;
  readonly path: string;
  readonly version?: string;
}

export interface MissingDependency extends DependencyBase {
  readonly found: false;
  readonly installHint: string;
}

export type DependencyStatus = FoundDependency | MissingDependency;
```

Key changes:
- `found: true` → `path` is required (not optional), `version` remains optional
- `found: false` → `installHint` is required, no `path`/`version`
- All fields `readonly` (natural since we're redesigning the type)
- `DependencyBase` is NOT exported (internal inheritance helper)

Then refactor `checkChromium()` (lines 91-120) to return the correct variant instead of mutating:
- Remove the mutable `status` object pattern
- Return `FoundDependency` object directly when browser found
- Return `MissingDependency` object at end when not found
- Structure: try to find browser → if found, build version, return FoundDependency → catch/fallthrough returns MissingDependency

Similarly refactor `checkLibreOffice()` (lines 125-152):
- Return `FoundDependency` when soffice found (with path and optional version)
- Return `MissingDependency` at end when not found

Update `formatDependencyReport()` (lines 175-222):
- In the `if (dep.found)` branch: TypeScript now narrows to `FoundDependency`
  - Remove `if (dep.path)` guard — `path` is always defined on FoundDependency, just always show it
  - Keep `if (dep.version)` — version is still optional on FoundDependency
- In the `else` branch: TypeScript now narrows to `MissingDependency`
  - Remove `|| 'No installation instructions available.'` fallback — `installHint` is always defined
  - Just use `dep.installHint` directly

In tests/utils/dependencies.test.ts:
- Update the `import type` to include `FoundDependency, MissingDependency` (or keep just `DependencyStatus` — both work)
- Line 33: Already correct (has path and version) — just add `as const` for `found: true` if needed
- Lines 73-84: The "found dep without version or path" test — this test demonstrates the INVALID STATE we're fixing. Change to include `path`:
  `{ name: 'BasicDep', required: true, found: true as const, path: '/usr/bin/basic' }`
  Update test name to "shows found dep without version" (path is now always shown)
- Lines 46-55: Already correct for MissingDependency (has installHint)
  </action>
  <verify>npx vitest run tests/utils/dependencies.test.ts --reporter=verbose && npx tsc --noEmit</verify>
  <done>DependencyStatus is discriminated union. checkChromium/checkLibreOffice return correct variants. formatDependencyReport uses narrowed types. No invalid states possible. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add PDFOptions library-level validation for scale and timeout</name>
  <files>src/converters/pdf-converter.ts, tests/pdf-converter.test.ts</files>
  <action>
In pdf-converter.ts, add validation at the top of `buildPdfOptions()` (the internal helper from Phase 26, currently at line 120):

```typescript
function buildPdfOptions(outputPath: string, options: PDFOptions, timeout: number) {
  // Library-level validation: catch invalid values at the boundary
  if (options.scale !== undefined && (options.scale < 0.1 || options.scale > 2)) {
    throw createError(ErrorCodes.INVALID_FORMAT,
      `PDF scale must be between 0.1 and 2, got ${options.scale}`);
  }
  if (timeout <= 0) {
    throw createError(ErrorCodes.INVALID_TIMEOUT, String(timeout));
  }

  return {
    // ... existing options object unchanged
  };
}
```

**Why validate in buildPdfOptions (not public functions):**
- Both public functions call buildPdfOptions — single validation point
- buildPdfOptions already receives the resolved timeout (not the raw option)
- Validation is about the PDF options contract, not about CLI parsing

**Error codes chosen:**
- Scale: `INVALID_FORMAT` — closest existing code for "invalid option value"
- Timeout: `INVALID_TIMEOUT` — already exists and is the exact right code

**Do NOT:**
- Change the public function signatures
- Add validation that duplicates CLI-level checks (parseTimeout already validates CLI input)
- Add a new ErrorCode (INVALID_SCALE would be over-engineering for one value)

In tests/pdf-converter.test.ts, add tests for invalid options:

Add a new describe block "PDFOptions validation" (or add to existing describe):

1. Test: scale below minimum (0.05) throws INVALID_FORMAT
2. Test: scale above maximum (3.0) throws INVALID_FORMAT
3. Test: scale at boundary (0.1) does NOT throw
4. Test: scale at boundary (2.0) does NOT throw
5. Test: timeout of 0 throws INVALID_TIMEOUT
6. Test: negative timeout throws INVALID_TIMEOUT

For tests 1-4, call `convertHTMLStringToPDF` with the invalid scale option and expect it to throw ConversionError with the right code. For tests 5-6, same with timeout.

Note: These tests test the library-level validation, NOT Puppeteer behavior. The errors should fire before Puppeteer is even called. Use simple HTML content `<html><body>test</body></html>`.
  </action>
  <verify>npx vitest run tests/pdf-converter.test.ts --reporter=verbose && npx tsc --noEmit</verify>
  <done>buildPdfOptions validates scale (0.1-2.0) and timeout (>0). Invalid values throw ConversionError with correct codes. 6 new tests pass. Existing tests unaffected.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` - all tests pass
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained (70%/60%)
- [ ] DependencyStatus is discriminated union (FoundDependency | MissingDependency)
- [ ] checkChromium/checkLibreOffice return correct variants
- [ ] formatDependencyReport uses narrowed types (no unnecessary guards)
- [ ] buildPdfOptions validates scale (0.1-2.0) and timeout (>0)
- [ ] No public API signature changes
</verification>

<success_criteria>

- DependencyStatus eliminates invalid states via discriminated union
- PDFOptions validated at library boundary (scale + timeout)
- All existing tests pass (with test updates for new type shapes)
- New validation tests added
- No TypeScript errors
- Coverage thresholds met
</success_criteria>

<output>
After completion, create `.planning/phases/27-type-design-safety/27-01-SUMMARY.md`
</output>
