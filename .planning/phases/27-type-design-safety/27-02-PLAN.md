---
phase: 27-type-design-safety
plan: 02
type: execute
---

<objective>
Fix 5 P2 type improvements: HeadingLevel safe cast, Chapter.id empty string fallback, readonly on result types, colors utility extraction, CLI options type naming.

Purpose: Improve type safety and module cohesion without changing runtime behavior (except HeadingLevel fallback and Chapter.id fallback which add safety). Library consumers unaffected — changes are internal or additive.
Output: Safer type casts, readonly result types, colors in own module, named CLI options type.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/27-type-design-safety/27-01-PLAN.md

# Source files to modify:
@src/parsers/html-parser.ts
@src/utils/errors.ts
@src/utils/logger.ts
@src/utils/dependencies.ts
@src/cli.ts
@src/converters/pdf-converter.ts
@src/converters/docx-converter.ts
@src/utils/output-handler.ts
@src/index.ts

# Test files (no test changes expected — all changes are type-level or internal):
# HeadingLevel type guard: tested via existing extractChapters tests (runtime fallback is defensive)
# Readonly: compile-time only — tests already pass
# Colors extraction: import path change only — no behavioral change
# CLI options: internal type naming — no behavioral change

**Established patterns:**
- TypeScript never type for exhaustive switch enforcement [Phase 23]
- Named exports in index.ts over export * [Phase 19]
- Shared utility pattern for cross-module operations (exec.ts) [Phase 26]

**Constraining decisions:**
- Chapter and ParsedDocument are NOT candidates for readonly — extractChapters mutates children via .push()
- HeadingLevel IS in public API (exported via index.ts) — type guard should also be exported
- colors is used by 4 files: errors.ts, logger.ts, dependencies.ts, cli.ts
- PDFResult, DOCXResult, OutputPaths, DependencyCheckResult are safe for readonly (constructed once, returned)
</context>

<tasks>

<task type="auto">
  <name>Task 1: HeadingLevel type guard + Chapter.id empty string fallback + readonly on result types</name>
  <files>src/parsers/html-parser.ts, src/converters/pdf-converter.ts, src/converters/docx-converter.ts, src/utils/output-handler.ts, src/utils/dependencies.ts</files>
  <action>
In html-parser.ts:

1. Add a type guard function after the HeadingLevel type (after line 12):
```typescript
export function isHeadingLevel(n: number): n is HeadingLevel {
  return Number.isInteger(n) && n >= 1 && n <= 6;
}
```

2. Replace the unsafe cast at line 82:
```typescript
// Before:
const level = parseInt(tagName.charAt(1), 10) as HeadingLevel;
// After:
const parsed = parseInt(tagName.charAt(1), 10);
const level: HeadingLevel = isHeadingLevel(parsed) ? parsed : 1;
```
This is defensive — Cheerio's `h1-h6` selector guarantees valid values, but the type guard makes the contract explicit rather than trusting the cast.

3. Fix Chapter.id empty string fallback at line 84:
```typescript
// Before:
const id = $el.attr('id') || generateId(title);
// After:
const id = $el.attr('id') || generateId(title) || `heading-${i}`;
```
Where `i` is the loop variable from `doc('h1, h2, h3, h4, h5, h6').each((i, el) => {`. Wait — that's a different loop. The `i` from `each()` is accessible as `_` (first param). But the headings are built in the `.each()` callback (line 79), where the first param is `_` (index). Change `_` to `i`:
```typescript
doc('h1, h2, h3, h4, h5, h6').each((i, el) => {
```
Then use `i` in the fallback:
```typescript
const id = $el.attr('id') || generateId(title) || `heading-${i}`;
```

4. Add readonly to result types that are constructed once and returned:

In pdf-converter.ts (line 34-36):
```typescript
export interface PDFResult {
  readonly buffer: Buffer;
}
```

In docx-converter.ts (lines 25-27):
```typescript
export interface DOCXResult {
  readonly outputPath: string;
}
```

In output-handler.ts (lines 29-34):
```typescript
export interface OutputPaths {
  readonly pdf: string;
  readonly docx: string;
  readonly baseName: string;
  readonly outputDir: string;
}
```

In dependencies.ts, add readonly to DependencyCheckResult (the result object from checkDependencies):
Find the `DependencyCheckResult` interface and add `readonly` to its fields. Note: this may already be done by Plan 27-01 if it made DependencyStatus fields readonly. Check what Plan 27-01 produces first — if DependencyCheckResult exists, add readonly. If not, skip (it's the return type of checkDependencies).

5. Export `isHeadingLevel` from index.ts — add to the html-parser export block:
```typescript
export {
  loadHTML,
  loadHTMLFromString,
  extractChapters,
  extractMetadata,
  parseDocument,
  isHeadingLevel,
} from './parsers/html-parser.js';
```
  </action>
  <verify>npx vitest run tests/html-parser.test.ts --reporter=verbose && npx tsc --noEmit</verify>
  <done>HeadingLevel has type guard (no more `as` cast). Chapter.id has fallback for empty titles. Result types have readonly fields. isHeadingLevel exported in public API. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Extract colors utility + name CLI options type</name>
  <files>src/utils/colors.ts (new), src/utils/errors.ts, src/utils/logger.ts, src/utils/dependencies.ts, src/cli.ts</files>
  <action>
1. Create new file `src/utils/colors.ts`:
```typescript
/**
 * Terminal Colors Utility
 *
 * ANSI color helpers for terminal output. Respects NO_COLOR environment variable.
 */

const supportsColor = process.stdout.isTTY && process.env.NO_COLOR === undefined;

export const colors = {
  red: (s: string): string => supportsColor ? `\x1b[31m${s}\x1b[0m` : s,
  green: (s: string): string => supportsColor ? `\x1b[32m${s}\x1b[0m` : s,
  yellow: (s: string): string => supportsColor ? `\x1b[33m${s}\x1b[0m` : s,
  blue: (s: string): string => supportsColor ? `\x1b[34m${s}\x1b[0m` : s,
  dim: (s: string): string => supportsColor ? `\x1b[2m${s}\x1b[0m` : s,
  bold: (s: string): string => supportsColor ? `\x1b[1m${s}\x1b[0m` : s,
};
```

2. Update imports in 4 files — replace `colors` import from errors.ts with colors.ts:

In errors.ts (lines 7-20): Remove the entire colors section (lines 7-20: comment block + supportsColor + colors object). Add import at top:
```typescript
import { colors } from './colors.js';
```
Keep the `export { colors }` re-export so existing importers don't break during transition. Actually, better: just update all importers directly and remove the export from errors.ts.

Wait — `colors` is NOT exported via index.ts (public API), so this is purely internal. Update all 4 import sites:

- errors.ts: Remove colors definition (lines 7-20). Add `import { colors } from './colors.js';` after existing imports. Remove the `export` keyword from `const colors` — actually, it's already defined and exported. Just replace the definition with an import. Keep the formatError function which uses colors.
- logger.ts (line 7): Change `import { colors } from './errors.js'` to `import { colors } from './colors.js'`
- dependencies.ts: Check if it imports colors from errors.ts. If so, change to colors.ts.
- cli.ts (line 25): Change `colors` import from `'./utils/errors.js'` to `'./utils/colors.js'`

3. Name the CLI options type in cli.ts. Extract the inline type at lines 62-71 to a named interface:

Before the `program` setup, add:
```typescript
interface CLIOptions {
  output?: string;
  format?: string;
  pdfOnly?: boolean;
  docxOnly?: boolean;
  timeout?: string;
  landscape?: boolean;
  force?: boolean;
  verbose?: boolean;
}
```

Then change the action callback signature from the inline type to:
```typescript
.action(async (input: string, options: CLIOptions) => {
```

CLIOptions is NOT exported — it's internal to the CLI module.
  </action>
  <verify>npx vitest run --reporter=verbose && npx tsc --noEmit</verify>
  <done>colors utility extracted to src/utils/colors.ts. All 4 importers updated. CLI options type named as CLIOptions. No behavioral changes. All tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` - all tests pass
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained (70%/60%)
- [ ] HeadingLevel has type guard function (no `as` cast)
- [ ] Chapter.id has fallback for empty generateId results
- [ ] PDFResult, DOCXResult, OutputPaths have readonly fields
- [ ] colors utility in own module (src/utils/colors.ts)
- [ ] errors.ts imports from colors.ts (no longer defines colors)
- [ ] CLI options type is named CLIOptions
- [ ] isHeadingLevel exported via index.ts
- [ ] No public API breaking changes
</verification>

<success_criteria>

- HeadingLevel cast replaced with type guard
- Chapter.id cannot be empty string (fallback to heading-N)
- Result types have readonly fields
- colors utility has proper module cohesion
- CLI options type is named for clarity
- All existing tests pass
- No TypeScript errors
- Coverage thresholds met
</success_criteria>

<output>
After completion, create `.planning/phases/27-type-design-safety/27-02-SUMMARY.md`
</output>
