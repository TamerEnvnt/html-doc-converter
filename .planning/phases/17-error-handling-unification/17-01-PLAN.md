---
phase: 17-error-handling-unification
plan: 01
type: execute
---

<objective>
Make DOCX converter throw ConversionError instead of returning success objects. Add output file verification after LibreOffice execution and rename error handling.

Purpose: Unify error handling between PDF and DOCX converters so both throw on failure. Eliminate the asymmetric {success: false} pattern that forces callers to handle two code paths.
Output: DOCX converter that throws ConversionError with specific error codes, verifies output exists, and handles rename failures.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files:
@src/converters/docx-converter.ts (177 lines - error handling at lines 99-155)
@src/utils/errors.ts (176 lines - ConversionError, ErrorCodes, createError)

# Prior phase context:
@.planning/phases/16-browser-singleton-hardening/16-01-SUMMARY.md

**Constraining decisions:**
- Phase 11: Use execFile (not shell-based) for all process execution
- Phase 16: Promise-lock pattern for singleton resources, null-before-close for cleanup safety

**Findings addressed (P0 + P1):**
1. P0: DOCX converter returns {success: false} instead of throwing (lines 107-112, 148-154)
2. P1: No output file verification after LibreOffice execution (after line 134)
3. P1: Missing rename error handling - fs.rename failure orphans generated file (lines 139-142)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make DOCX converter throw ConversionError instead of returning error objects</name>
  <files>src/converters/docx-converter.ts, src/utils/errors.ts</files>
  <action>
**In docx-converter.ts:**

1. Change the `DOCXResult` interface (line 26-30): Remove the `success` and `error` fields. New shape should be just `{ outputPath: string }`. This is the "if you got a result, it worked" pattern.

2. Change `convertToDOCX` function (lines 99-155):
   - Import `ConversionError`, `createError`, `ErrorCodes` from `../utils/errors.js`
   - When soffice not found (lines 106-112): throw `createError(ErrorCodes.LIBREOFFICE_MISSING)` instead of returning `{success: false}`
   - After `execFileAsync` succeeds (around line 134): Add output file verification - check that `generatedPath` exists with `fs.access(generatedPath)`. If not, throw `createError(ErrorCodes.DOCX_FAILED, 'LibreOffice completed but output file not found: ' + generatedPath)`
   - Wrap `fs.rename` (line 141) in try-catch. On rename error: throw `createError(ErrorCodes.DOCX_FAILED, 'Failed to rename output file: ' + renameError.message)`. Do NOT delete the generated file in this case - let the user recover it.
   - In the catch block (lines 148-154): Instead of returning `{success: false}`, throw `createError(ErrorCodes.DOCX_FAILED, error.message)`. Preserve the original error as `cause` (pass `{cause: error}` to ConversionError constructor or use the createError pattern).
   - Return `{ outputPath: absoluteOutputPath }` on success (no `success: true` field needed)

3. Change `convertHTMLFileToDOCX` function (lines 168-176): Return type changes to `{ document: ParsedDocument; docx: DOCXResult }` - no change needed since DOCXResult shape changed.

**In errors.ts:**
- No changes needed to ErrorCodes or createError - LIBREOFFICE_MISSING and DOCX_FAILED already exist.

**What to avoid:**
- Do NOT add new ErrorCodes for output verification or rename failure - use DOCX_FAILED with descriptive detail strings.
- Do NOT change the public API signatures (function names, parameters). Only the return type of convertToDOCX changes.
- Do NOT touch findSoffice or verifyLibreOffice - those are Phase 19 scope.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
Verify the `DOCXResult` type no longer has `success` or `error` fields.
  </verify>
  <done>
- DOCXResult is `{ outputPath: string }` (no success/error fields)
- convertToDOCX throws ConversionError instead of returning error objects
- Output file verified after LibreOffice execution
- fs.rename wrapped in try-catch
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update DOCX tests for throw-based error handling</name>
  <files>tests/docx-converter.test.ts</files>
  <action>
Update existing DOCX converter tests to match the new throw-based error handling:

1. **Update test "convertToDOCX returns error for non-existent soffice" (line 15-31):**
   - Rename to "convertToDOCX throws ConversionError when LibreOffice not found"
   - Instead of checking `result.success === false`, use `expect(async () => await convertToDOCX(...)).rejects.toThrow(ConversionError)` pattern
   - If LibreOffice IS installed on the test machine, this test will not throw - handle both cases. Use a mock approach: mock `findSoffice` to return null, then verify the throw.
   - Actually simplest approach: import ConversionError, try/catch, check if error has code LIBREOFFICE_MISSING. Or conditionally skip if LO is installed.

2. **Keep tests "findSoffice returns string or null" and "verifyLibreOffice returns boolean" unchanged** - these functions didn't change.

3. **Keep source-scanning tests (lines 55-81) unchanged** - these are testing execFile usage, not error handling.

4. **Add new test "convertToDOCX returns outputPath on success":** Only runs if LibreOffice is installed. Call convertToDOCX with a fixture file, verify result has `outputPath` string, verify result does NOT have `success` or `error` properties. Clean up output file.

**What to avoid:**
- Do NOT add elaborate mocks for LibreOffice execution - the E2E tests already cover actual conversion
- Keep tests simple: verify the type shape changed and errors are thrown not returned
  </action>
  <verify>
`npm test` passes all tests including updated DOCX tests.
`npm run build` still succeeds.
  </verify>
  <done>
- DOCX tests updated for throw-based error handling
- At least one test verifies ConversionError is thrown (not returned as object)
- All existing tests still pass (141+)
- No regressions
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] `npm run typecheck` passes
- [ ] DOCXResult no longer has `success` or `error` fields
- [ ] convertToDOCX throws ConversionError on all failure paths
- [ ] Output file verified after LibreOffice execution
- [ ] fs.rename wrapped in try-catch
</verification>

<success_criteria>

- DOCXResult simplified to `{ outputPath: string }`
- All DOCX error paths throw ConversionError
- Output file existence verified post-conversion
- Rename failure handled (doesn't orphan files silently)
- All tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-handling-unification/17-01-SUMMARY.md`
</output>
