---
phase: 17-error-handling-unification
plan: 02
type: execute
---

<objective>
Add timeout-specific errors to PDF converter and update CLI to use unified throw-based error handling for both converters.

Purpose: Complete the error handling unification by making the CLI handle both converters symmetrically (both throw, no more result.success checks), and distinguish timeout errors with ErrorCodes.TIMEOUT in the PDF path.
Output: CLI simplified to single try/catch per converter, PDF converter uses TIMEOUT error code, all error paths consistent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files:
@src/cli.ts (296 lines - DOCX handling at lines 218-244)
@src/converters/pdf-converter.ts (309 lines - timeout handling at lines 132-136, 186-204)
@src/utils/errors.ts (ErrorCodes.TIMEOUT exists but unused in PDF path)

# Prior plan in this phase:
@.planning/phases/17-error-handling-unification/17-01-PLAN.md
(After 17-01: DOCXResult is { outputPath: string }, convertToDOCX throws ConversionError)

**Constraining decisions:**
- Phase 16: Promise-lock pattern, null-before-close for cleanup safety
- 17-01: DOCX converter now throws ConversionError (not returns error objects)

**Findings addressed:**
- P1: Timeout errors not distinguished (ErrorCodes.TIMEOUT never used in PDF path)
- Implicit: CLI needs updating since DOCX converter API changed in 17-01
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timeout-specific error detection in PDF converter</name>
  <files>src/converters/pdf-converter.ts</files>
  <action>
**In convertToPDF (lines 118-214):**

The `page.goto()` (line 133) and `page.pdf()` (line 206) calls can throw TimeoutError from Puppeteer. Currently these propagate as generic errors. Wrap the conversion logic to detect timeout errors specifically:

1. In the `try` block, catch errors from `page.goto()` and `page.pdf()`. Check if the error is a Puppeteer TimeoutError (check `error.name === 'TimeoutError'` or `error.message.includes('timeout')`).

2. If timeout detected: import `createError` and `ErrorCodes` from `../utils/errors.js`, then throw `createError(ErrorCodes.TIMEOUT, 'PDF generation timed out after ' + timeout + 'ms')`.

3. For non-timeout errors: re-throw as-is (let them propagate to the caller which wraps in ConversionError).

**In convertHTMLStringToPDF (lines 242-308):**

Same pattern - detect timeout from `page.setContent()` and `page.pdf()`:

1. `page.setContent()` at line 251 currently doesn't pass `timeout` from options. Add timeout: `await page.setContent(html, { waitUntil: 'networkidle0', timeout: options.timeout || 60000 })`.

2. `page.pdf()` at line 300 is missing timeout. Add `timeout: options.timeout || 60000` to the pdfOptions object.

3. Wrap the conversion section in timeout detection logic (same as convertToPDF).

**What to avoid:**
- Do NOT wrap the entire function in a new try-catch. The existing `try/finally` at lines 126/211 handles page cleanup. Add timeout detection INSIDE that try block.
- Do NOT change function signatures or PDFResult type.
- Do NOT add a global timeout (setTimeout) - use Puppeteer's built-in timeout mechanisms.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
`npm run typecheck` passes.
  </verify>
  <done>
- Puppeteer TimeoutError detected and re-thrown as ConversionError with ErrorCodes.TIMEOUT
- convertHTMLStringToPDF now respects options.timeout for setContent and pdf calls
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify CLI to use unified throw-based error handling</name>
  <files>src/cli.ts</files>
  <action>
**Update DOCX conversion section (lines 218-244):**

After 17-01, `convertToDOCX` throws on failure instead of returning `{success: false}`. The CLI must be updated:

1. Remove the `result.success` check (lines 223-234). Since convertToDOCX now throws on failure, success is implicit if no exception.

2. Simplify to:
   ```
   try {
     const result = await convertToDOCX(inputPath, outputPaths.docx, { timeout });
     // If we get here, it succeeded
     console.log(` ${colors.green('Done')}`);
     console.log(`         ${colors.dim('->')} ${result.outputPath}`);
     successCount++;
     createdFiles.push(result.outputPath);
   } catch (err) {
     console.log(` ${colors.red('FAILED')}`);
     errorCount++;
     // err is already ConversionError from the converter
     if (err instanceof ConversionError) {
       console.error(`         ${formatError(err)}`);
     } else {
       const docxError = createError(ErrorCodes.DOCX_FAILED, err instanceof Error ? err.message : 'unknown error');
       console.error(`         ${formatError(docxError)}`);
     }
   }
   ```

3. The `outputPaths.docx` reference on the success path should change to `result.outputPath` since DOCXResult now provides the actual output path.

**What to avoid:**
- Do NOT change the PDF conversion section (lines 192-215) - it already uses try/catch correctly since convertToPDF has always thrown.
- Do NOT change exit code logic (lines 259-263) - still correct.
- Do NOT change any CLI options, arguments, or help text.
- Do NOT remove the ConversionError import - it's still used for the outer catch block.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
`npm test` passes all tests.
  </verify>
  <done>
- CLI DOCX section uses try/catch only (no result.success check)
- ConversionError from converter displayed directly
- Non-ConversionError wrapped in createError
- All tests pass
- Build clean
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] `npm run typecheck` passes
- [ ] ErrorCodes.TIMEOUT used for PDF timeout detection
- [ ] convertHTMLStringToPDF respects options.timeout
- [ ] CLI DOCX section has no result.success check
- [ ] Both converters handled symmetrically in CLI (both via try/catch)
</verification>

<success_criteria>

- PDF converter detects TimeoutError and throws ConversionError with TIMEOUT code
- convertHTMLStringToPDF passes timeout to setContent and pdf calls
- CLI DOCX handling simplified to try/catch (no result.success)
- Both converters handled identically in CLI
- All tests pass
- Phase 17 complete (both plans)
</success_criteria>

<output>
After completion, create `.planning/phases/17-error-handling-unification/17-02-SUMMARY.md`
</output>
