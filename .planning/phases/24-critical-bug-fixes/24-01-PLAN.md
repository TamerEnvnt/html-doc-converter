---
phase: 24-critical-bug-fixes
plan: 01
type: execute
---

<objective>
Fix 3 P1 bugs identified in post-v1.2 code review: signal handler unhandled promise rejection, page.close() error masking in PDF converter, and invalid --format value silent no-op.

Purpose: These bugs cause silent failures or error masking in production use, undermining the robustness work done in v1.2.
Output: All 3 bugs fixed with regression tests. No new test files needed - extend existing test suites.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependency context (from Phase 23 - most recent, same subsystem):
@.planning/phases/23-resilience-final-polish/23-01-SUMMARY.md

# Source files to modify:
@src/cli.ts
@src/converters/pdf-converter.ts
@src/cli-helpers.ts

# Test files to extend:
@tests/cli.test.ts
@tests/converters/pdf-converter.test.ts
@tests/cli-helpers.test.ts

**Established patterns:**
- closeBrowser() null-before-close pattern: safe for cleanup, never throws (Phase 16)
- Throw-on-failure: converters throw ConversionError, callers use try/catch (Phase 17)
- Signal handlers registered before program.parse() (Phase 23)
- TypeScript never type for exhaustive switch (Phase 23)
- Extract-to-test: move inline CLI logic to importable helpers (Phase 22)

**Constraining decisions:**
- Phase 16: closeBrowser() wraps close() in try/catch - already safe. Signal handler should follow same pattern.
- Phase 17: ConversionError with ErrorCodes is the error surface. INVALID_FORMAT already exists as an ErrorCode.
- Phase 23: Signal handlers exist at cli.ts:267-274. This phase fixes the async handling bug in them.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix signal handler unhandled promise rejection</name>
  <files>src/cli.ts, tests/cli.test.ts</files>
  <action>
In cli.ts lines 273-274, the arrow functions call async `handleSignal()` but don't handle the returned Promise. If closeBrowser() rejects (unlikely but possible), it becomes an unhandled rejection that crashes with a confusing error instead of a clean exit.

Fix the signal handler registration (lines 273-274) to chain `.catch()` on the returned Promise:
```
process.on('SIGINT', () => { handleSignal('SIGINT').catch(() => process.exit(130)); });
process.on('SIGTERM', () => { handleSignal('SIGTERM').catch(() => process.exit(143)); });
```

This ensures: (a) if closeBrowser() succeeds, process.exit runs from inside handleSignal; (b) if closeBrowser() rejects, the catch handler still exits with the correct signal code.

Do NOT change the handleSignal function itself - it's correct. Only fix the event registration lines.

In tests/cli.test.ts, update the existing signal handler test to verify the .catch() pattern is present by checking that the handlers are registered (the existing test may already cover this - verify and adjust if needed).
  </action>
  <verify>npx vitest run tests/cli.test.ts --reporter=verbose passes</verify>
  <done>Signal handlers have .catch() fallback. No unhandled promise rejection possible from signal cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Fix page.close() error masking in PDF converter finally blocks</name>
  <files>src/converters/pdf-converter.ts, tests/converters/pdf-converter.test.ts</files>
  <action>
In pdf-converter.ts, two finally blocks have bare `await page.close()` that can mask the original conversion error:
- Line 227 (convertToPDF): `await page.close();`
- Line 339 (convertHTMLStringToPDF): `await page.close();`

If the try block throws a ConversionError and then page.close() also throws (e.g., browser crashed mid-conversion), the page.close() error replaces the original, making debugging impossible.

Fix BOTH finally blocks to wrap page.close() in try/catch, following the same pattern as closeBrowser() (lines 92-106):
```typescript
} finally {
  try {
    await page.close();
  } catch {
    // Silently discard close errors - cleanup must not mask conversion errors
  }
}
```

Do NOT add logging in the catch block - this is the same silent-discard pattern used by closeBrowser(). The comment explains WHY.

Add a test in pdf-converter.test.ts that verifies: when page.pdf() throws AND page.close() also throws, the original page.pdf() error propagates (not the page.close() error). Mock both to throw different errors and assert the original error is received by the caller.
  </action>
  <verify>npx vitest run tests/converters/pdf-converter.test.ts --reporter=verbose passes</verify>
  <done>Both finally blocks wrap page.close() in try/catch. Original conversion errors always propagate even when cleanup fails.</done>
</task>

<task type="auto">
  <name>Task 3: Fix invalid --format value silent no-op</name>
  <files>src/cli-helpers.ts, tests/cli-helpers.test.ts</files>
  <action>
In cli-helpers.ts, `determineFormats()` lines 26-28: when `options.format` is an invalid value like "xyz", both `generatePDF` and `generateDOCX` are set to false. The CLI then produces no output and exits with code 0 - a silent success with no work done.

Fix: After the existing if/else-if chain (after line 29), add a validation check:
```typescript
if (!generatePDF && !generateDOCX) {
  throw createError(ErrorCodes.INVALID_FORMAT, `invalid format '${options.format}', expected: pdf, docx, or both`);
}
```

This reuses the existing INVALID_FORMAT ErrorCode (already used for invalid file extensions in validateInputFile). The error message clearly states what was given and what's expected.

Note: This check also catches the impossible edge case where both --pdf-only and --docx-only are somehow both false after the if chain. But the primary fix is for invalid format strings.

Add tests in cli-helpers.test.ts:
1. `determineFormats({ format: 'xyz' })` throws ConversionError with INVALID_FORMAT
2. `determineFormats({ format: 'pdf' })` still works (regression check)
3. `determineFormats({ format: 'docx' })` still works (regression check)
4. `determineFormats({ format: 'both' })` still works (regression check)
  </action>
  <verify>npx vitest run tests/cli-helpers.test.ts --reporter=verbose passes</verify>
  <done>Invalid --format values throw INVALID_FORMAT error instead of silently producing no output. Valid values still work.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx vitest run` - all tests pass (185+ tests)
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained (70% lines/functions/statements, 60% branches)
- [ ] Signal handler: `.catch()` present on both SIGINT and SIGTERM registrations
- [ ] PDF converter: both finally blocks wrap page.close() in try/catch
- [ ] CLI helpers: invalid format throws INVALID_FORMAT error
</verification>

<success_criteria>

- All 3 P1 bugs fixed
- Regression tests added for each fix
- All existing tests still pass
- Coverage thresholds met
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-critical-bug-fixes/24-01-SUMMARY.md`
</output>
