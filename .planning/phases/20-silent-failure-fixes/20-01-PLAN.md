---
phase: 20-silent-failure-fixes
plan: 01
type: execute
---

<objective>
Fix silent failure patterns: TOCTOU races in overwrite protection and directory creation, EACCES swallowed in soffice detection, missing error cause chains in HTML parser.

Purpose: Eliminate scenarios where errors are silently swallowed or race conditions cause incorrect behavior under concurrent/adversarial conditions.
Output: Hardened file operations, accurate permission error reporting, proper error cause chains.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (affects: 20-silent-failure-fixes):
@.planning/phases/17-error-handling-unification/17-02-SUMMARY.md
(After 17-02: PDF timeout detection, convertHTMLStringToPDF timeout passthrough, CLI symmetric error handling)
@.planning/phases/19-architecture-packaging/19-01-SUMMARY.md
(After 19-01: findSoffice/verifyLibreOffice now in src/utils/soffice.ts, curated public API)

# Source files:
@src/cli.ts (lines 148-157: overwrite check uses sync fileExists before async conversion)
@src/utils/output-handler.ts (lines 86-93: ensureOutputDirectory uses fs.access then fs.mkdir)
@src/utils/soffice.ts (lines 44-51: findSoffice bare catch ignores EACCES)
@src/parsers/html-parser.ts (lines 40-49: loadHTML wraps errors without {cause})

**Constraining decisions:**
- Phase 17: Throw-on-failure pattern (converters throw ConversionError, callers use try/catch)
- Phase 17: CLI symmetric error handling (ConversionError passthrough before wrapping in generic codes)
- Phase 19: findSoffice/verifyLibreOffice extracted to src/utils/soffice.ts
- Phase 19: ConversionError/ErrorCodes/createError exported from index.ts

**Scope reduction:**
- convertHTMLStringToPDF timeout: Already fixed in Phase 17-02 (lines 266-274, 326-333 of pdf-converter.ts)
- DOCX output verification + rename handling: Already fixed in Phase 17-01 (docx-converter.ts lines 79-93)

**Findings addressed (remaining):**
- P1: TOCTOU in overwrite protection (cli.ts:148-157) - fileExists() check racy with conversion write
- P1: ensureOutputDirectory TOCTOU + EACCES misinterpretation (output-handler.ts:86-93)
- P1: findSoffice swallows EACCES (reports "not found" for permission errors) (soffice.ts:44-51)
- P2: loadHTML loses original error context (no {cause}) (html-parser.ts:44-48)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TOCTOU in overwrite protection and ensureOutputDirectory</name>
  <files>src/cli.ts, src/utils/output-handler.ts</files>
  <action>
**1a. Fix ensureOutputDirectory TOCTOU (output-handler.ts lines 86-93):**

Replace the `fs.access` + `fs.mkdir` pattern with just `fs.mkdir({ recursive: true })` which is atomic and idempotent. The `recursive: true` flag means mkdir won't throw if the directory already exists.

Current code:
```
try {
  await fs.access(dirPath);
} catch {
  await fs.mkdir(dirPath, { recursive: true });
}
```

Replace with:
```
await fs.mkdir(dirPath, { recursive: true });
```

This is both simpler AND correct:
- No TOCTOU: single atomic call
- No EACCES misinterpretation: if mkdir fails with EACCES, the error propagates correctly
- Idempotent: `recursive: true` doesn't error if directory exists

**1b. Fix TOCTOU in overwrite protection (cli.ts lines 148-157):**

The current pattern checks `fileExists()` (sync) before conversion, but a file could be created between check and write. For a CLI tool, this TOCTOU is low-risk (same user process), but we can improve it.

Replace the `fileExists` check with `fs.access` (async) to reduce the time window, AND add a comment acknowledging the inherent TOCTOU in check-then-act patterns:

Change lines 149-157 from using sync `fileExists()` to:
```typescript
if (!options.force) {
  const existing: string[] = [];
  if (generatePDF) {
    try { await fs.access(outputPaths.pdf); existing.push(outputPaths.pdf); } catch { /* doesn't exist - good */ }
  }
  if (generateDOCX) {
    try { await fs.access(outputPaths.docx); existing.push(outputPaths.docx); } catch { /* doesn't exist - good */ }
  }

  if (existing.length > 0) {
    throw createError(ErrorCodes.FILE_EXISTS, existing.join(', '));
  }
}
```

This is still check-then-act (inherent TOCTOU), but:
- Uses async fs.access (non-blocking, consistent with rest of file)
- Reduces syncâ†’async time gap
- The real protection for PDF is Puppeteer's `path` option (overwrites atomically)
- The real protection for DOCX is LibreOffice writing to tempdir + rename

Do NOT introduce file locking or O_EXCL - overkill for a CLI tool where the user controls the filesystem.

**1c. Remove unused fileExists from cli.ts imports:**

After switching to fs.access, remove `fileExists` from the import at line 19. If `fileExists` is no longer used anywhere outside output-handler.ts, keep it exported (tests or future consumers may use it) but remove the import from cli.ts.

**What to avoid:**
- Do NOT use O_EXCL/O_CREAT for overwrite protection - the converters (Puppeteer/LibreOffice) handle file creation, not the CLI
- Do NOT add file locking - unnecessary complexity for a single-user CLI
- Do NOT change how converters write files - they have their own atomic patterns
  </action>
  <verify>
`npm run build` succeeds.
`npm run typecheck` passes.
`npm test` passes all tests.
Verify ensureOutputDirectory has no `fs.access` call: `grep "fs.access" src/utils/output-handler.ts` returns nothing.
Verify cli.ts no longer imports fileExists: `grep "fileExists" src/cli.ts` returns nothing.
  </verify>
  <done>
- ensureOutputDirectory uses single `fs.mkdir({ recursive: true })` call (no TOCTOU)
- CLI overwrite check uses async fs.access (reduced TOCTOU window)
- fileExists import removed from cli.ts
- Build passes, all tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix findSoffice EACCES handling and loadHTML error cause chains</name>
  <files>src/utils/soffice.ts, src/parsers/html-parser.ts</files>
  <action>
**2a. Fix findSoffice EACCES swallowing (soffice.ts lines 44-51):**

The current code uses bare `catch { continue }` which treats permission denied (EACCES) the same as file not found (ENOENT). When a user has LibreOffice installed but the binary lacks execute permission, findSoffice incorrectly returns null ("not found").

Change the loop (lines 44-51) to distinguish EACCES from ENOENT:

```typescript
for (const p of paths) {
  try {
    await fs.access(p, fs.constants.X_OK);
    return p;
  } catch (err) {
    if ((err as NodeJS.ErrnoException).code === 'EACCES') {
      throw new Error(`LibreOffice found at ${p} but lacks execute permission`);
    }
    // ENOENT or other: try next path
    continue;
  }
}
```

This way:
- ENOENT: silently try next path (correct behavior)
- EACCES: throw immediately with actionable message (user needs `chmod +x`)
- Other errors: try next path (safe default)

Also apply the same pattern to the `which`/`where` fallback (lines 54-60). The `which` fallback catch block should remain as-is (bare catch returning null) because `which` failures are always "not found" scenarios - the binary either exists in PATH or doesn't. EACCES on the `which` command itself is not meaningful.

**2b. Fix loadHTML missing error cause chains (html-parser.ts lines 40-49):**

The current code catches errors and re-throws with `new Error(message)`, losing the original error context. Add `{ cause }` to preserve the chain:

Change lines 44-48:
```typescript
} catch (error) {
  if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
    throw new Error(`HTML file not found: ${filePath}`, { cause: error });
  }
  throw new Error(`Failed to load HTML file: ${(error as Error).message}`, { cause: error });
}
```

The `{ cause }` option is ES2022 and supported in Node.js 16.9+. This project targets Node.js 18+ (confirmed by package.json engines field or TypeScript target).

**What to avoid:**
- Do NOT change findSoffice return type (still `string | null`) - EACCES throws, not returns null
- Do NOT wrap EACCES in ConversionError - findSoffice is a utility, not a converter. The caller (verifyLibreOffice/checkDependencies) decides how to surface errors
- Do NOT change the `which`/`where` fallback error handling - those failures are always "not found"
  </action>
  <verify>
`npm run build` succeeds.
`npm run typecheck` passes.
`npm test` passes all tests.
Verify EACCES handling in soffice.ts: `grep "EACCES" src/utils/soffice.ts` returns match.
Verify cause chains in html-parser.ts: `grep "cause" src/parsers/html-parser.ts` returns matches.
  </verify>
  <done>
- findSoffice throws on EACCES with actionable message (instead of silently returning null)
- loadHTML preserves original error via { cause } in both ENOENT and generic catch paths
- Build passes, all tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] `npm run typecheck` passes
- [ ] ensureOutputDirectory has no TOCTOU (single mkdir call)
- [ ] CLI overwrite check uses async fs.access (not sync fileExists)
- [ ] findSoffice distinguishes EACCES from ENOENT
- [ ] loadHTML error re-throws include { cause }
</verification>

<success_criteria>

- TOCTOU in ensureOutputDirectory eliminated (single atomic mkdir)
- CLI overwrite protection upgraded to async (reduced TOCTOU window)
- findSoffice throws on EACCES (actionable permission error, not silent "not found")
- loadHTML preserves error cause chains
- All tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/20-silent-failure-fixes/20-01-SUMMARY.md`
</output>
