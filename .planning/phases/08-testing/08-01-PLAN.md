---
phase: 08-testing
plan: 01
type: execute
---

<objective>
Create comprehensive test coverage with unit tests and E2E tests using real HTML samples.

Purpose: Ensure reliability and catch regressions as the tool evolves.
Output: Test suite covering parser, converters, and CLI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Depends on:** Phase 6 (Output Handling), Phase 7 (Cross-Platform)

**Test framework:** Vitest (installed in Phase 1)

**Test HTML source:** `/Users/tamer/Work/AI/Claude/InfraSizingCalculator/docs/srs/SRS_InfraSizingCalculator.html`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up test infrastructure and unit tests for parser</name>
  <files>vitest.config.ts, tests/html-parser.test.ts, tests/fixtures/</files>
  <action>
    1. Create vitest.config.ts:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           globals: true,
           environment: 'node',
           include: ['tests/**/*.test.ts'],
           coverage: {
             provider: 'v8',
             reporter: ['text', 'html'],
           },
         },
       });
       ```

    2. Create test fixtures directory with sample HTML:
       ```
       tests/
         fixtures/
           simple.html      — minimal HTML document
           with-chapters.html — document with h1/h2/h3 structure
           with-tables.html — document with tables
       ```

    3. Create parser unit tests:
       ```typescript
       // tests/html-parser.test.ts
       import { describe, it, expect } from 'vitest';
       import { parseDocument, loadHTMLFromString } from '../src/parsers/html-parser.js';

       describe('HTML Parser', () => {
         describe('loadHTMLFromString', () => {
           it('parses valid HTML', () => {
             const doc = loadHTMLFromString('<html><body><h1>Title</h1></body></html>');
             expect(doc('h1').text()).toBe('Title');
           });
         });

         describe('extractChapters', () => {
           it('extracts h1 as top-level chapters', () => { ... });
           it('nests h2 under h1', () => { ... });
           it('handles documents without h1', () => { ... });
         });

         describe('extractMetadata', () => {
           it('extracts title from head', () => { ... });
           it('extracts meta tags', () => { ... });
         });
       });
       ```

    4. Add test script to package.json:
       ```json
       "scripts": {
         "test": "vitest",
         "test:run": "vitest run",
         "test:coverage": "vitest run --coverage"
       }
       ```
  </action>
  <verify>npm test runs and parser tests pass</verify>
  <done>Parser has unit test coverage; tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E tests with SRS document</name>
  <files>tests/e2e/conversion.test.ts</files>
  <action>
    Create integration tests that convert real documents:

    ```typescript
    // tests/e2e/conversion.test.ts
    import { describe, it, expect, beforeAll, afterAll } from 'vitest';
    import { convertToPDF, closeBrowser } from '../src/converters/pdf-converter.js';
    import { convertToDOCX, verifyLibreOffice } from '../src/converters/docx-converter.js';
    import * as fs from 'fs/promises';
    import * as path from 'path';

    const SRS_PATH = '/Users/tamer/Work/AI/Claude/InfraSizingCalculator/docs/srs/SRS_InfraSizingCalculator.html';
    const OUTPUT_DIR = './tests/output';

    describe('E2E Conversion', () => {
      beforeAll(async () => {
        await fs.mkdir(OUTPUT_DIR, { recursive: true });
      });

      afterAll(async () => {
        await closeBrowser();
      });

      describe('PDF Conversion', () => {
        it('converts SRS document to PDF', async () => {
          const outputPath = path.join(OUTPUT_DIR, 'srs.pdf');
          const result = await convertToPDF(SRS_PATH, outputPath);

          expect(result.buffer).toBeDefined();
          expect(result.buffer.length).toBeGreaterThan(0);

          const stats = await fs.stat(outputPath);
          expect(stats.size).toBeGreaterThan(10000);
        }, 60000);
      });

      describe('DOCX Conversion', () => {
        it('converts SRS document to DOCX', async () => {
          const hasLO = await verifyLibreOffice();
          if (!hasLO) {
            console.log('Skipping DOCX test: LibreOffice not installed');
            return;
          }

          const outputPath = path.join(OUTPUT_DIR, 'srs.docx');
          const result = await convertToDOCX(SRS_PATH, outputPath);

          expect(result.success).toBe(true);

          const stats = await fs.stat(outputPath);
          expect(stats.size).toBeGreaterThan(1000);
        }, 60000);
      });
    });
    ```

    Tests should have long timeouts and skip DOCX gracefully if LibreOffice missing.
  </action>
  <verify>E2E tests pass with SRS document</verify>
  <done>E2E tests verify real document conversion</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI tests using Vitest</name>
  <files>tests/cli.test.ts</files>
  <action>
    Test CLI behavior using Vitest with child_process.execFileSync (safer than exec):

    ```typescript
    // tests/cli.test.ts
    import { describe, it, expect } from 'vitest';
    import { execFileSync } from 'child_process';

    describe('CLI', () => {
      it('shows help with --help', () => {
        // Use execFileSync with array args (no shell injection risk)
        const output = execFileSync('node', ['dist/cli.js', '--help'], {
          encoding: 'utf-8'
        });
        expect(output).toContain('html-doc-converter');
        expect(output).toContain('--format');
      });

      it('shows version with --version', () => {
        const output = execFileSync('node', ['dist/cli.js', '--version'], {
          encoding: 'utf-8'
        });
        expect(output.trim()).toMatch(/\d+\.\d+\.\d+/);
      });

      it('errors on missing input file', () => {
        expect(() => {
          execFileSync('node', ['dist/cli.js', 'nonexistent.html'], {
            encoding: 'utf-8'
          });
        }).toThrow();
      });

      it('runs check command', () => {
        const output = execFileSync('node', ['dist/cli.js', 'check'], {
          encoding: 'utf-8'
        });
        expect(output).toContain('LibreOffice');
      });
    });
    ```

    Note: Uses execFileSync instead of execSync for security (no shell interpolation).
  </action>
  <verify>CLI tests pass</verify>
  <done>CLI behavior verified through tests</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` runs all tests
- [ ] Parser unit tests pass
- [ ] E2E conversion tests pass (PDF always, DOCX if LibreOffice installed)
- [ ] CLI tests pass
- [ ] Test coverage report generated
</verification>

<success_criteria>

- All tasks completed
- Test suite provides confidence in code
- E2E tests verify real-world usage
</success_criteria>

<output>
After completion, create `.planning/phases/08-testing/08-01-SUMMARY.md`
</output>
