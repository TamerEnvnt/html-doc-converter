---
phase: 30-error-message-quality
plan: 01
type: execute
---

<objective>
Improve error message quality: replace plain Error with ConversionError in html-parser, add verbose logging to silent cleanup catch blocks.

Purpose: Consistent error types enable the CLI's error formatting (code + suggestion) across all modules. Verbose logging in cleanup blocks aids debugging without breaking cleanup safety.
Output: All error paths produce ConversionError, cleanup blocks log at verbose level.

Note: The P1 finding "browser launch errors give misleading message" was already fixed by Phase 29 Task 2 (getBrowser now throws specific ConversionError). This plan addresses the remaining 2 findings.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/parsers/html-parser.ts
@src/converters/pdf-converter.ts
@src/utils/errors.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Replace plain Error with ConversionError in html-parser loadHTML()</name>
  <files>src/parsers/html-parser.ts</files>
  <action>
  In loadHTML() at lines 45-55, the function throws plain `new Error(...)` in both catch branches. Replace with ConversionError:

  1. Add import at top of file: `import { createError, ErrorCodes } from '../utils/errors.js';`

  2. ENOENT branch (line 51): Replace `throw new Error(...)` with `throw createError(ErrorCodes.INPUT_NOT_FOUND, filePath);`
     This produces: "Input file not found: {path}" with suggestion "Check the file path and ensure the file exists."

  3. Other errors branch (line 53): Replace `throw new Error(...)` with `throw createError(ErrorCodes.UNKNOWN, \`Failed to load HTML file: \${(error as Error).message}\`);`
     This produces: "Failed to load HTML file: {message}" with suggestion "Please report this issue with details."

  Keep the existing error discrimination (ENOENT vs other) — just change the Error constructor.
  Do NOT change loadHTMLFromString, extractChapters, extractMetadata, or parseDocument.
  Do NOT remove the `{ cause: error }` — actually, ConversionError's constructor doesn't accept a cause option, so just drop it. The original error message is preserved in the detail string.
  </action>
  <verify>npx vitest run tests/html-parser.test.ts --reporter=verbose 2>&1 | tail -20</verify>
  <done>loadHTML throws ConversionError (INPUT_NOT_FOUND for ENOENT, UNKNOWN for other). Parser tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add verbose logging to silent cleanup catch blocks in pdf-converter</name>
  <files>src/converters/pdf-converter.ts</files>
  <action>
  Import `verbose` from logger and add logging to 3 catch blocks that currently silently discard errors:

  1. Add import: `import { verbose } from '../utils/logger.js';`

  2. closeBrowser() catch block (line 106): Change empty catch to:
     ```
     catch (error) {
       verbose('Browser close error (non-fatal):', error instanceof Error ? error.message : String(error));
     }
     ```

  3. convertToPDF() finally page.close catch (line 270): Change empty catch to:
     ```
     catch (error) {
       verbose('Page close error (non-fatal):', error instanceof Error ? error.message : String(error));
     }
     ```

  4. convertHTMLStringToPDF() finally page.close catch (line 365): Same as #3.

  These catch blocks MUST remain catch blocks (never re-throw) — they're cleanup code in finally blocks. The only change is adding verbose logging so errors are visible with --verbose flag.
  Do NOT change any other code in the file.
  </action>
  <verify>npx vitest run tests/pdf-converter.test.ts --reporter=verbose 2>&1 | tail -20</verify>
  <done>All 3 cleanup catch blocks log at verbose level. PDF converter tests pass.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` — all 194 tests pass (192 passed, 2 skipped)
- [ ] `npx tsc --noEmit` — no TypeScript errors
- [ ] html-parser loadHTML throws ConversionError (not plain Error)
- [ ] pdf-converter cleanup catch blocks contain verbose() calls
</verification>

<success_criteria>
- 2 remaining findings fixed across 2 files
- All existing tests still pass
- No new TypeScript errors
- Cleanup catch blocks never re-throw (still safe for finally blocks)
</success_criteria>

<output>
After completion, create `.planning/phases/30-error-message-quality/30-01-SUMMARY.md`
</output>
