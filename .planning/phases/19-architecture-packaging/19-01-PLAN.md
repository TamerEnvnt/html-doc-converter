---
phase: 19-architecture-packaging
plan: 01
type: execute
---

<objective>
Break circular dependency, fix public API surface, add package.json exports field, and make CLI version dynamic.

Purpose: Clean up module architecture so utilities don't depend on converters, consumers only see intended API, and package metadata is correct for npm publishing.
Output: Clean dependency graph, curated public exports, proper package.json exports field, dynamic CLI version.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase (directly affects this one):
@.planning/phases/18-type-design-cleanup/18-01-SUMMARY.md
(After 18-01: Types cleaned, dead fields removed, HeadingLevel exported)

# Source files:
@src/index.ts (lines 1-14: export * from all modules - leaky API)
@src/utils/dependencies.ts (line 11: imports findSoffice from docx-converter - circular dep)
@src/converters/docx-converter.ts (lines 54-85: findSoffice + verifyLibreOffice - should be internal)
@src/cli.ts (line 37: hardcoded version '1.0.0')
@package.json (no exports field, version 1.0.0)

# Tests that may be affected:
@tests/utils/dependencies.test.ts (imports from dependencies.ts)

**Constraining decisions:**
- Phase 17: DOCXResult simplified to { outputPath: string }
- Phase 17: Throw-on-failure pattern (converters throw ConversionError)
- Phase 18: Types cleaned (HeadingLevel exported from html-parser.ts)

**Findings addressed:**
- Circular dependency: dependencies.ts imports findSoffice from docx-converter.ts
- ConversionError/ErrorCodes not exported from index.ts
- Missing exports field in package.json
- CLI version hardcoded as '1.0.0'
- findSoffice/verifyLibreOffice unnecessarily exposed in public API
</context>

<tasks>

<task type="auto">
  <name>Task 1: Break circular dependency and fix public API surface</name>
  <files>src/utils/soffice.ts, src/utils/dependencies.ts, src/converters/docx-converter.ts, src/cli.ts, src/index.ts</files>
  <action>
**1a. Extract findSoffice to src/utils/soffice.ts:**

Create a new file `src/utils/soffice.ts` that contains the `findSoffice` function (currently at docx-converter.ts lines 54-78) and `verifyLibreOffice` (lines 81-91). Move both functions there.

The new file needs these imports:
```
import { execFile } from 'child_process';
import { promisify } from 'util';
import { getPlatform } from './platform.js';
```

**1b. Update docx-converter.ts:**
- Remove the `findSoffice` and `verifyLibreOffice` function definitions
- Add import: `import { findSoffice, verifyLibreOffice } from '../utils/soffice.js';`
- Keep `findSoffice` usage inside `convertToDOCX` (line 104) - it calls findSoffice internally
- Do NOT change the export of `convertToDOCX` or `convertHTMLFileToDOCX`
- Do NOT re-export findSoffice or verifyLibreOffice from docx-converter (they should only come from soffice.ts now)

**1c. Update dependencies.ts:**
- Change line 11 from: `import { findSoffice } from '../converters/docx-converter.js';`
- To: `import { findSoffice } from './soffice.js';`
- This breaks the circular dependency (utils no longer imports from converters)

**1d. Update cli.ts:**
- Change line 10 from: `import { convertToDOCX, verifyLibreOffice } from './converters/docx-converter.js';`
- To: `import { convertToDOCX } from './converters/docx-converter.js';`
- Add: `import { verifyLibreOffice } from './utils/soffice.js';`

**1e. Fix index.ts to curate public API:**
Replace the blanket `export *` with named exports:

```typescript
/**
 * HTML Document Converter
 *
 * Convert HTML documents to PDF and DOCX with high fidelity.
 */

// PDF converter (public API)
export {
  convertToPDF,
  convertHTMLFileToPDF,
  convertHTMLStringToPDF,
  getBrowser,
  closeBrowser,
} from './converters/pdf-converter.js';
export type { PDFOptions, PDFResult } from './converters/pdf-converter.js';

// DOCX converter (public API)
export {
  convertToDOCX,
  convertHTMLFileToDOCX,
} from './converters/docx-converter.js';
export type { DOCXOptions, DOCXResult } from './converters/docx-converter.js';

// HTML parser (public API)
export {
  loadHTML,
  loadHTMLFromString,
  extractChapters,
  extractMetadata,
  parseDocument,
} from './parsers/html-parser.js';
export type {
  HeadingLevel,
  Chapter,
  DocumentMetadata,
  ParsedDocument,
} from './parsers/html-parser.js';

// Error types (public API - consumers need these to catch ConversionError)
export { ConversionError, ErrorCodes, createError } from './utils/errors.js';
export type { ErrorCode } from './utils/errors.js';
```

This ensures:
- findSoffice/verifyLibreOffice are NOT in public API (internal only)
- ConversionError/ErrorCodes ARE exported (consumers need to catch them)
- formatError and colors stay internal (CLI cosmetics, not library API)
- HeadingLevel is exported (added in Phase 18)
- DependencyStatus, checkDependencies, formatDependencyReport stay internal

**What to avoid:**
- Do NOT change function implementations - only move locations and update imports
- Do NOT remove `export` from findSoffice/verifyLibreOffice in soffice.ts - they need to be importable by internal modules
- Do NOT change test imports yet - tests import from source modules directly, not from index.ts
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
`npm run typecheck` passes.
Verify circular dependency is broken: `grep -r "from.*docx-converter" src/utils/` returns nothing.
  </verify>
  <done>
- findSoffice and verifyLibreOffice live in src/utils/soffice.ts
- dependencies.ts imports from utils/soffice.ts (not converters)
- cli.ts imports verifyLibreOffice from utils/soffice.ts
- index.ts uses named exports (no `export *`)
- ConversionError, ErrorCodes, createError exported from index.ts
- findSoffice/verifyLibreOffice NOT exported from index.ts
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add package.json exports field and dynamic CLI version</name>
  <files>package.json, src/cli.ts</files>
  <action>
**2a. Add exports field to package.json:**

Add an `exports` field after the `types` field. This tells Node.js and bundlers exactly what entry points are available:

```json
"exports": {
  ".": {
    "import": "./dist/index.js",
    "types": "./dist/index.d.ts"
  }
},
```

Keep the existing `main` and `types` fields for backwards compatibility with older tooling.

**2b. Make CLI version dynamic:**

In `src/cli.ts`, line 37 currently reads:
```
.version('1.0.0')
```

Replace with reading version from package.json. Since we're in an ESM project, use `createRequire` to load the JSON:

```typescript
import { createRequire } from 'module';
const require = createRequire(import.meta.url);
const pkg = require('../package.json') as { version: string };
```

Then change `.version('1.0.0')` to `.version(pkg.version)`.

Place the import at the top of the file (with other imports). Place the `createRequire`/`require`/`pkg` lines after the other imports, before `const program = new Command();`.

**What to avoid:**
- Do NOT use `fs.readFileSync` for package.json (fragile path resolution from dist/)
- Do NOT use import assertions (`import pkg from '../package.json' assert { type: 'json' }`) - still experimental and requires tsconfig changes
- Do NOT change the version number in package.json itself (that's a release concern, not this phase)
  </action>
  <verify>
`npm run build` succeeds.
`npm test` passes all tests.
`node dist/cli.js --version` outputs '1.0.0' (the current package.json version).
  </verify>
  <done>
- package.json has exports field with "." entry for import + types
- CLI version is read from package.json dynamically
- Build passes
- All tests pass
- `--version` output matches package.json version
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm test` passes all tests
- [ ] `npm run typecheck` passes
- [ ] No circular dependency: `grep -r "from.*docx-converter" src/utils/` returns empty
- [ ] findSoffice/verifyLibreOffice NOT in index.ts
- [ ] ConversionError/ErrorCodes ARE in index.ts exports
- [ ] package.json has exports field
- [ ] `node dist/cli.js --version` outputs version from package.json
</verification>

<success_criteria>

- Circular dependency broken (dependencies.ts no longer imports from docx-converter)
- Public API curated (named exports, no leaky internals)
- ConversionError/ErrorCodes exported for library consumers
- package.json exports field added
- CLI version dynamic (reads from package.json)
- All tests pass
- Build clean
</success_criteria>

<output>
After completion, create `.planning/phases/19-architecture-packaging/19-01-SUMMARY.md`
</output>
