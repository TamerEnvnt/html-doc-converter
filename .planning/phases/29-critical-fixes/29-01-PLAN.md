---
phase: 29-critical-fixes
plan: 01
type: execute
---

<objective>
Fix 3 P1 critical bugs found during 5-agent review: signal handler hang, browser launch timeout, DOCX timeout operator.

Purpose: Eliminate the most severe bugs that can cause process hangs and silent data corruption.
Output: All 3 files patched, existing tests still pass, no new runtime errors.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@src/cli.ts
@src/converters/pdf-converter.ts
@src/converters/docx-converter.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Harden signal handlers with force-exit timeout and re-entrance guard</name>
  <files>src/cli.ts</files>
  <action>
  Refactor the signal handler at lines 278-285:

  1. Add a re-entrance guard (`let shuttingDown = false`) so double Ctrl+C doesn't run cleanup concurrently. If already shutting down, force-exit immediately.

  2. Add a force-exit timeout (3 seconds) using `setTimeout(() => process.exit(exitCode), 3000).unref()` BEFORE calling `closeBrowser()`. This guarantees exit even if Puppeteer is frozen.

  3. In the `.catch()` callbacks (line 284-285), log the error at verbose level instead of silently discarding it. Use `verbose('Signal cleanup error:', err)` before calling `process.exit()`.

  Keep the existing exit codes (130 for SIGINT, 143 for SIGTERM).
  Do NOT change the `closeBrowser()` function itself — that's in pdf-converter.ts.
  Do NOT add any new imports beyond what's already imported.
  </action>
  <verify>npx vitest run --reporter=verbose 2>&1 | tail -20</verify>
  <done>Signal handler has re-entrance guard, 3-second force-exit timeout, and verbose error logging. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add explicit timeout to browser launch</name>
  <files>src/converters/pdf-converter.ts</files>
  <action>
  Add an explicit `timeout` option to `puppeteer.launch()` at line 64-67:

  1. Add `timeout: 30000` (30s) to the launch options object. Puppeteer does have a default timeout, but making it explicit documents the constraint and prevents silent behavioral changes if Puppeteer defaults change.

  2. Wrap the launch error (catch block at line 80-83) with a specific ConversionError. Currently the error just re-throws raw — wrap it: if the error message contains 'timeout', throw `createError(ErrorCodes.TIMEOUT, 'Browser launch timed out after 30000ms')`. Otherwise throw `createError(ErrorCodes.PDF_FAILED, 'Failed to launch browser: ' + error.message)`.

  Import `createError` and `ErrorCodes` — already imported at line 10.
  Do NOT change the singleton pattern or the promise-lock logic.
  Do NOT change closeBrowser() or any page-level code.
  </action>
  <verify>npx vitest run --reporter=verbose 2>&1 | tail -20</verify>
  <done>puppeteer.launch() has explicit timeout:30000. Launch errors wrapped with specific ConversionError messages. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Fix DOCX timeout nullish coalescing</name>
  <files>src/converters/docx-converter.ts</files>
  <action>
  Fix line 78: change `options.timeout || 60000` to `options.timeout ?? 60000`.

  The `||` operator treats `0` as falsy, so `timeout: 0` silently becomes `60000`. The `??` operator only falls back on `null`/`undefined`, preserving explicit `0` values.

  This is a one-line fix. Do NOT change anything else in the file.
  </action>
  <verify>npx vitest run --reporter=verbose 2>&1 | tail -20</verify>
  <done>`options.timeout ?? 60000` used instead of `||`. Explicit timeout:0 is now respected. All existing tests pass.</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` — all 194 tests pass (192 passed, 2 skipped)
- [ ] `npx tsc --noEmit` — no TypeScript errors
- [ ] Signal handler: re-entrance guard variable exists, setTimeout force-exit exists, verbose logging in .catch()
- [ ] Browser launch: explicit timeout:30000 in launch options, ConversionError wrapping in catch
- [ ] DOCX timeout: `??` operator used instead of `||`
</verification>

<success_criteria>
- 3 P1 bugs fixed across 3 files
- All existing tests still pass
- No new TypeScript errors
- No behavioral changes for normal (non-edge-case) flows
</success_criteria>

<output>
After completion, create `.planning/phases/29-critical-fixes/29-01-SUMMARY.md`:

# Phase 29: Critical Fixes Summary

**[Substantive one-liner]**

## Accomplishments

## Files Modified

## Decisions Made

## Issues Encountered

## Next Phase Readiness
</output>
