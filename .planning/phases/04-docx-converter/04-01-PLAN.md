---
phase: 04-docx-converter
plan: 01
type: execute
---

<objective>
Convert HTML documents to DOCX using LibreOffice CLI for fully editable Word documents.

Purpose: Create the DOCX conversion pipeline that produces real document structure (headings, tables, paragraphs) that can be genuinely edited in Microsoft Word.
Output: Working DOCX converter module that generates editable Word documents from HTML.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Depends on:** Phase 2 (HTML Parser) — document parsing and structure

**Core requirement (from PROJECT.md):**
DOCX must have real document structure (headings, paragraphs, tables) that enables genuine editing in Word — NOT floating text boxes.

**LibreOffice CLI command (from research):**
```bash
soffice --headless --convert-to docx --outdir /output/dir input.html
```

**Key options:**
- `--headless` — run without GUI (required)
- `--convert-to docx` — output format
- `--outdir` — output directory

**Platform-specific soffice paths:**
- macOS: `/Applications/LibreOffice.app/Contents/MacOS/soffice`
- Linux: `/usr/bin/soffice` or `/usr/lib/libreoffice/program/soffice`
- Windows: `C:\Program Files\LibreOffice\program\soffice.exe`

**Sources:**
- https://technicallywewrite.com/2024/02/09/libreofficecommand
- https://wiki.documentfoundation.org/Faq/General/150
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LibreOffice CLI integration</name>
  <files>src/converters/docx-converter.ts</files>
  <action>
    Create DOCX converter module with LibreOffice detection:

    1. Define types:
       ```typescript
       interface DOCXOptions {
         outputDir?: string;
         preserveStyles?: boolean;
       }

       interface DOCXResult {
         outputPath: string;
         success: boolean;
         error?: string;
       }
       ```

    2. Create LibreOffice path detection:
       ```typescript
       import { execSync, exec } from 'child_process';
       import { promisify } from 'util';
       import * as fs from 'fs/promises';
       import * as path from 'path';

       const execAsync = promisify(exec);

       const SOFFICE_PATHS = {
         darwin: [
           '/Applications/LibreOffice.app/Contents/MacOS/soffice',
           '/opt/homebrew/bin/soffice',
         ],
         linux: [
           '/usr/bin/soffice',
           '/usr/lib/libreoffice/program/soffice',
           '/snap/bin/libreoffice',
         ],
         win32: [
           'C:\\Program Files\\LibreOffice\\program\\soffice.exe',
           'C:\\Program Files (x86)\\LibreOffice\\program\\soffice.exe',
         ],
       };

       async function findSoffice(): Promise<string | null> {
         const platform = process.platform as keyof typeof SOFFICE_PATHS;
         const paths = SOFFICE_PATHS[platform] || [];

         for (const p of paths) {
           try {
             await fs.access(p, fs.constants.X_OK);
             return p;
           } catch {
             continue;
           }
         }

         // Try which/where as fallback
         try {
           const cmd = platform === 'win32' ? 'where soffice' : 'which soffice';
           const { stdout } = await execAsync(cmd);
           return stdout.trim().split('\n')[0];
         } catch {
           return null;
         }
       }
       ```

    3. Add verification function:
       ```typescript
       async function verifyLibreOffice(): Promise<boolean> {
         const sofficePath = await findSoffice();
         return sofficePath !== null;
       }
       ```

    4. Export findSoffice and verifyLibreOffice for cross-platform phase.
  </action>
  <verify>findSoffice() returns valid path on current system (if LibreOffice installed)</verify>
  <done>LibreOffice detection works across platforms; clear error if not found</done>
</task>

<task type="auto">
  <name>Task 2: Implement DOCX conversion</name>
  <files>src/converters/docx-converter.ts</files>
  <action>
    Create main conversion function:

    ```typescript
    async function convertToDOCX(
      htmlPath: string,
      outputPath: string,
      options: DOCXOptions = {}
    ): Promise<DOCXResult> {
      // Find LibreOffice
      const sofficePath = await findSoffice();
      if (!sofficePath) {
        return {
          outputPath: '',
          success: false,
          error: 'LibreOffice not found. Please install LibreOffice to convert to DOCX.',
        };
      }

      // Resolve paths
      const absoluteHtmlPath = path.resolve(htmlPath);
      const outputDir = options.outputDir || path.dirname(outputPath);
      const expectedOutputName = path.basename(htmlPath, path.extname(htmlPath)) + '.docx';

      // Ensure output directory exists
      await fs.mkdir(outputDir, { recursive: true });

      // Build command
      // Quote paths for spaces
      const args = [
        '--headless',
        '--convert-to', 'docx',
        '--outdir', `"${outputDir}"`,
        `"${absoluteHtmlPath}"`
      ];

      try {
        await execAsync(`"${sofficePath}" ${args.join(' ')}`);

        // LibreOffice outputs to: outputDir/originalName.docx
        const generatedPath = path.join(outputDir, expectedOutputName);

        // Rename if different output path requested
        const finalPath = path.resolve(outputPath);
        if (generatedPath !== finalPath) {
          await fs.rename(generatedPath, finalPath);
        }

        return {
          outputPath: finalPath,
          success: true,
        };
      } catch (error) {
        return {
          outputPath: '',
          success: false,
          error: `LibreOffice conversion failed: ${error instanceof Error ? error.message : String(error)}`,
        };
      }
    }
    ```

    Key implementation notes:
    - LibreOffice outputs to `--outdir` with original filename + .docx extension
    - Need to rename if user wants different output filename
    - Quote all paths to handle spaces
    - Return result object with success/error status
  </action>
  <verify>Convert SRS document to DOCX; open in Word and verify structure is editable</verify>
  <done>convertToDOCX() generates editable DOCX with real headings/tables</done>
</task>

<task type="auto">
  <name>Task 3: Add convenience functions and export API</name>
  <files>src/converters/docx-converter.ts, src/index.ts</files>
  <action>
    1. Add convenience function with parser integration:
       ```typescript
       async function convertHTMLFileToDOCX(
         htmlPath: string,
         outputPath: string,
         options?: DOCXOptions
       ): Promise<{ document: ParsedDocument; docx: DOCXResult }> {
         const document = await parseDocument(htmlPath);
         const docx = await convertToDOCX(htmlPath, outputPath, options);
         return { document, docx };
       }
       ```

    2. Export from src/converters/docx-converter.ts:
       - convertToDOCX
       - convertHTMLFileToDOCX
       - findSoffice
       - verifyLibreOffice
       - DOCXOptions type
       - DOCXResult type

    3. Update src/index.ts to include DOCX exports:
       ```typescript
       export * from './converters/pdf-converter.js';
       export * from './converters/docx-converter.js';
       export * from './parsers/html-parser.js';
       ```

    4. Add import for parseDocument at top of docx-converter.ts:
       ```typescript
       import { parseDocument, ParsedDocument } from '../parsers/html-parser.js';
       ```
  </action>
  <verify>All exports accessible from index.ts; TypeScript compiles</verify>
  <done>Full DOCX API exported; integration complete</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` compiles without errors
- [ ] `verifyLibreOffice()` returns true (if installed)
- [ ] Convert SRS document to DOCX successfully
- [ ] Open DOCX in Word — headings are real headings (show in Navigation)
- [ ] Open DOCX in Word — tables are editable tables (not images)
- [ ] All exports accessible from index.ts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- DOCX output has real document structure (not text boxes)
- Ready for Phase 5 (CLI Interface) integration
</success_criteria>

<output>
After completion, create `.planning/phases/04-docx-converter/04-01-SUMMARY.md`:

# Phase 4 Plan 1: DOCX Converter Summary

**[Substantive one-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `src/converters/docx-converter.ts` - Complete DOCX conversion module
- `src/index.ts` - Updated exports

## Decisions Made

[Any decisions made during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 5: CLI Interface
- Both converters complete (PDF and DOCX)
- LibreOffice detection implemented
- Public API exported
</output>
