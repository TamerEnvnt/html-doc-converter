---
phase: 26-code-deduplication-cleanup
plan: 01
type: execute
---

<objective>
Extract shared helpers in pdf-converter.ts to eliminate ~46 lines of duplication across convertToPDF and convertHTMLStringToPDF. Consolidate promisify(execFile) repeated in 3 files into shared utility.

Purpose: Reduce maintenance burden from duplicated code. Changes to PDF options or timeout detection currently require edits in 2 places (easy to miss one). execFileAsync pattern repeated identically in 3 files.
Output: pdf-converter.ts with 3 internal helpers. New src/utils/exec.ts shared by 3 consumers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/25-error-handling-gaps/25-01-SUMMARY.md

# Source files to modify:
@src/converters/pdf-converter.ts
@src/utils/dependencies.ts
@src/utils/soffice.ts
@src/converters/docx-converter.ts

# Test files (read to verify no breakage):
@tests/pdf-converter.test.ts

**Established patterns:**
- Throw-on-failure: converters throw ConversionError, callers use try/catch [Phase 17]
- Finally-block cleanup: wrap close/cleanup in try/catch to avoid masking errors [Phase 24]
- addStyleTag wrapped in try/catch with PDF_FAILED [Phase 25]

**Constraining decisions:**
- CSS injection intentionally differs between convertToPDF (full document: diagrams, scrollbars, overflow) and convertHTMLStringToPDF (simple: tables, overflow-x). Do NOT unify CSS.
- The public API surface (index.ts) exports convertToPDF, convertHTMLStringToPDF, convertHTMLFileToPDF — signatures must NOT change.
- New helpers should be module-internal (not exported from the module or index.ts).

**P2 finding deferred:**
- "CLI PDF/DOCX conversion blocks identical pattern (~50 lines)" evaluated. Blocks differ in 5+ dimensions (converter function, options, format label, error code, output path). Per "three similar lines > premature abstraction" principle, extracting a helper would reduce readability. Consciously deferred.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared PDF helpers and refactor both converter functions</name>
  <files>src/converters/pdf-converter.ts, tests/pdf-converter.test.ts</files>
  <action>
In pdf-converter.ts, three patterns are duplicated between convertToPDF (lines 118-239) and convertHTMLStringToPDF (lines 267-361):

1. **Timeout detection** — used 4 times (2 navigation + 2 PDF generation):
   Lines 139, 223, 280, 345 all check `error.name === 'TimeoutError' || error.message.includes('timeout')`.

2. **PDF options building** — used 2 times:
   Lines 199-217 and 321-339 build identical pdfOptions objects.

3. **PDF generation with timeout** — used 2 times:
   Lines 219-227 and 340-349 call page.pdf() with timeout error detection.

Extract 3 INTERNAL helpers (NOT exported — place above the public functions, after closeBrowser):

```typescript
// ============================================================================
// Internal Helpers (shared between convertToPDF and convertHTMLStringToPDF)
// ============================================================================

/** Check if an error is a Puppeteer timeout error */
function isTimeoutError(error: unknown): boolean {
  return error instanceof Error &&
    (error.name === 'TimeoutError' || error.message.includes('timeout'));
}

/** Build merged PDF options from user options + defaults */
function buildPdfOptions(outputPath: string, options: PDFOptions, timeout: number) {
  return {
    path: outputPath,
    format: options.format || 'A4',
    printBackground: options.printBackground ?? true,
    preferCSSPageSize: options.preferCSSPageSize ?? true,
    landscape: options.landscape ?? false,
    margin: options.margin || {
      top: '0',
      right: '0',
      bottom: '0',
      left: '0',
    },
    displayHeaderFooter: options.displayHeaderFooter ?? false,
    headerTemplate: options.headerTemplate || '',
    footerTemplate: options.footerTemplate || '',
    scale: options.scale || 1,
    timeout,
  };
}

/** Generate PDF with timeout detection. Returns raw Buffer. */
async function generatePdf(
  page: import('puppeteer').Page,
  pdfOptions: ReturnType<typeof buildPdfOptions>,
): Promise<Buffer> {
  try {
    const pdfBuffer = await page.pdf(pdfOptions);
    return Buffer.from(pdfBuffer);
  } catch (error) {
    if (isTimeoutError(error)) {
      throw createError(ErrorCodes.TIMEOUT, `PDF generation timed out after ${pdfOptions.timeout}ms`);
    }
    throw error;
  }
}
```

Then refactor BOTH converter functions to use these helpers:

**convertToPDF changes:**
- Navigation timeout catch: replace inline check with `if (isTimeoutError(error))`
- Replace lines 199-217 with: `const pdfOptions = buildPdfOptions(outputPath, options, pdfTimeout);`
- Replace lines 219-231 with: `const buffer = await generatePdf(page, pdfOptions); return { buffer };`

**convertHTMLStringToPDF changes:**
- Content timeout catch: replace inline check with `if (isTimeoutError(error))`
- Replace lines 321-339 with: `const pdfOptions = buildPdfOptions(outputPath, options, pdfTimeout);`
- Replace lines 340-353 with: `const buffer = await generatePdf(page, pdfOptions); return { buffer };`

Do NOT change:
- CSS injection (intentionally different CSS between the two functions)
- addStyleTag try/catch wrappers (already correct from Phase 25)
- page.close() finally blocks (already correct from Phase 24)
- Public function signatures
- The `import('puppeteer').Page` type annotation — use this form to avoid adding a named import for Page

Verify: All existing pdf-converter tests still pass. The refactoring is purely internal — no behavior changes.
  </action>
  <verify>npx vitest run tests/pdf-converter.test.ts --reporter=verbose passes</verify>
  <done>3 internal helpers extracted. Both converter functions use shared helpers. No duplicated timeout detection or PDF options building. All existing tests pass unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate promisify(execFile) into shared utility</name>
  <files>src/utils/exec.ts, src/utils/dependencies.ts, src/utils/soffice.ts, src/converters/docx-converter.ts</files>
  <action>
Three files repeat the same 3-line pattern:
- `src/utils/dependencies.ts` lines 9,15
- `src/utils/soffice.ts` lines 9,14
- `src/converters/docx-converter.ts` lines 9,16

Each has:
```typescript
import { promisify } from 'util';
import { execFile } from 'child_process';
const execFileAsync = promisify(execFile);
```

Create a new shared utility file:

**Create `src/utils/exec.ts`:**
```typescript
/**
 * Shared promisified exec utilities.
 */
import { promisify } from 'util';
import { execFile } from 'child_process';

export const execFileAsync = promisify(execFile);
```

**Update each consumer:**

1. `src/utils/dependencies.ts`: Remove `import { promisify } from 'util';` and `import { execFile } from 'child_process';` and `const execFileAsync = promisify(execFile);`. Add: `import { execFileAsync } from './exec.js';`

2. `src/utils/soffice.ts`: Same removals. Add: `import { execFileAsync } from './exec.js';`

3. `src/converters/docx-converter.ts`: Same removals. Add: `import { execFileAsync } from '../utils/exec.js';` (note: different relative path since docx-converter is in converters/)

Verify each consumer still works — `execFileAsync` is used identically in all 3 files.

Do NOT add exec.ts to index.ts exports — this is an internal utility, not part of the public API.
  </action>
  <verify>npx vitest run tests/utils/dependencies.test.ts tests/utils/soffice.test.ts tests/docx-converter.test.ts --reporter=verbose passes</verify>
  <done>src/utils/exec.ts created. 3 consumer files updated. No duplicated promisify(execFile). All tests pass.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx vitest run` - all tests pass
- [ ] `npx tsc --noEmit` - no TypeScript errors
- [ ] Coverage thresholds maintained (70%/60%)
- [ ] pdf-converter.ts: 3 internal helpers, no duplicated timeout/options/generation code
- [ ] src/utils/exec.ts: single source for execFileAsync
- [ ] No changes to public API (index.ts exports unchanged)
- [ ] CSS injection still differs between convertToPDF and convertHTMLStringToPDF
</verification>

<success_criteria>

- PDF converter duplication eliminated (~46 lines saved)
- promisify consolidation complete (3 files → 1 source)
- All existing tests pass without changes
- No public API changes
- No TypeScript errors
- Coverage thresholds met
</success_criteria>

<output>
After completion, create `.planning/phases/26-code-deduplication-cleanup/26-01-SUMMARY.md`
</output>
