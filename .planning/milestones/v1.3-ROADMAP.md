# Milestone v1.3: Polish & Cleanup

**Status:** SHIPPED 2026-02-19
**Phases:** 24-28
**Total Plans:** 9

## Overview

Fix remaining P1 bugs from post-v1.2 review, eliminate code duplication, remove dead code, improve type safety, and fill test coverage gaps. Source: Full 5-agent codebase review (2026-02-15) post-v1.2. 24 unique findings (8 P1 code, 3 P1 test, 13 P2).

## Phases

### Phase 24: Critical Bug Fixes

**Goal**: Fix 3 P1 bugs: signal handler async issue, page.close() error masking, invalid format silent no-op
**Depends on**: Milestone 3 complete
**Priority:** P1
**Plans**: 1 plan

Plans:
- [x] 24-01: Fix signal handler async, page.close masking, invalid format no-op (3 tasks)

Findings addressed:
- P1: Signal handler async not awaited (closeBrowser may not complete before process.exit)
- P1: page.close() in finally blocks masks original conversion errors (2 locations)
- P1: Invalid --format value silently produces no output with exit code 0

### Phase 25: Error Handling Gaps

**Goal**: Add missing error handling: check command try/catch, DOCX mkdir error code, addStyleTag wrapping, platform fallback warning, validateInputFile simplification
**Depends on**: Phase 24
**Priority:** P1/P2
**Plans**: 2 plans

Plans:
- [x] 25-01: Check command try/catch, DOCX mkdir error code, addStyleTag wrapping (3 tasks)
- [x] 25-02: Platform fallback warning, validateInputFile TOCTOU elimination (2 tasks)

Findings addressed:
- P1: check command has no try/catch (unhandled rejections)
- P1: DOCX mkdir failure throws DOCX_FAILED instead of OUTPUT_DIR_FAILED
- P2: addStyleTag() failure unhandled (raw Puppeteer error)
- P2: Platform silent fallback to linux without warning
- P2: validateInputFile TOCTOU between fs.access and fs.stat/readFile

### Phase 26: Code Deduplication & Cleanup

**Goal**: Extract shared helpers in pdf-converter.ts (~80 lines duplicated), remove 16 unused exported functions, consolidate promisify
**Depends on**: Phase 25
**Priority:** P1/P2
**Plans**: 2 plans

Plans:
- [x] 26-01: PDF converter deduplication + promisify consolidation (2 tasks)
- [x] 26-02: Dead code removal across utilities (2 tasks)

Findings addressed:
- P1: pdf-converter.ts CSS injection, PDF options, timeout detection duplicated across 2 functions
- P2: 16 unused exported functions across platform.ts, logger.ts, output-handler.ts
- P2: promisify(execFile) repeated in 3 files

### Phase 27: Type Design & Safety

**Goal**: DependencyStatus discriminated union, PDFOptions library validation, readonly fields, HeadingLevel safe cast, colors extraction
**Depends on**: Phase 26
**Priority:** P1/P2
**Plans**: 2 plans

Plans:
- [x] 27-01: DependencyStatus discriminated union + PDFOptions library-level validation (2 tasks)
- [x] 27-02: HeadingLevel type guard + readonly result types + colors extraction + CLI options naming (2 tasks)

Findings addressed:
- P1: DependencyStatus allows invalid states (boolean+optional anti-pattern)
- P1: PDFOptions no library-level validation of scale/timeout
- P2: Mutable data types (PDFResult, DOCXResult, OutputPaths, DependencyCheckResult)
- P2: HeadingLevel unsafe as cast
- P2: colors utility in errors.ts (module cohesion)
- P2: Inline CLI options type should be named

### Phase 28: Test Coverage & Verification

**Goal**: Fill P1 test gaps, add P2 tests, final coverage verification
**Depends on**: Phase 27
**Priority:** P1/P2
**Plans**: 2 plans

Plans:
- [x] 28-01: P1 test coverage (soffice EACCES/fallback, pdf non-timeout rethrow, docx non-Error throw, html-parser non-ENOENT) (3 tasks)
- [x] 28-02: P2 test coverage + final verification (platform getPlatformName, dependencies optional dep, coverage check) (2 tasks)

Findings addressed:
- P1: soffice.ts EACCES path + which fallback untested (28.57% branch coverage)
- P1: pdf-converter non-timeout error rethrow untested
- P1: Non-Error throw handling in convertToDOCX untested
- P2: loadHTML non-ENOENT error path untested
- P2: platform.ts getPlatformName non-current platform branches untested
- P2: dependencies.ts optional dep formatting untested

---

## Milestone Summary

**Key Decisions:**
- Async signal handlers: chain .catch() to prevent unhandled rejections (Phase 24)
- Finally-block cleanup: wrap close/cleanup in try/catch to avoid masking errors (Phase 24)
- Single I/O pattern: one fs.readFile with ENOENT check replaces access+stat+readFile chain (Phase 25)
- Internal helper extraction for module-level deduplication (Phase 26)
- Shared utility pattern for cross-module operations (exec.ts) (Phase 26)
- Dead code removal: verify unused via grep before removing (Phase 26)
- Discriminated union over boolean+optional anti-pattern (Phase 27)
- Type guard functions over unsafe `as` casts (Phase 27)

**Issues Resolved:**
- All 24 findings from post-v1.2 review addressed (11 P1, 13 P2)
- soffice.ts branch coverage improved from 28.57% to 92.3%
- platform.ts reached 100% coverage across all metrics
- 16 dead exported functions removed

**Issues Deferred:**
- None — all findings addressed

**Technical Debt Incurred:**
- None — this milestone was specifically about paying down debt

---

_For current project status, see .planning/ROADMAP.md_
