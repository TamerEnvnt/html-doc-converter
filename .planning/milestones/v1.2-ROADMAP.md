# Milestone v1.2: Robustness & API Quality

**Status:** SHIPPED 2026-02-15
**Phases:** 16-23
**Total Plans:** 11

## Overview

Address all findings from comprehensive 5-agent code review. Fix critical concurrency bugs, unify error handling, clean up type design, improve test coverage for public APIs, and prepare package for production consumers.

**Source:** Full codebase review (2026-02-10) using code-reviewer, silent-failure-hunter, test-analyzer, type-design-analyzer, and architecture-explorer agents. 29 findings across P0/P1/P2 priorities.

## Phases

### Phase 16: Browser Singleton Hardening

**Goal**: Fix race condition in getBrowser(), add crash recovery with disconnected handler, make closeBrowser() safe in finally blocks
**Depends on**: Milestone 2 complete
**Priority:** P0 - CRITICAL
**Plans**: 1 plan

Plans:
- [x] 16-01: Browser singleton hardening (2 tasks, completed 2026-02-10)

Findings addressed:
- P0: Browser singleton race condition (concurrent launches)
- P0: No crash recovery (stale browserInstance after Chromium crash)
- P0: closeBrowser() throws in finally block, masking original error

### Phase 17: Error Handling Unification

**Goal**: Make both converters use consistent error handling (throw ConversionError). Fix DOCX converter to throw instead of returning success objects. Add specific error types for timeout, missing output, rename failures.
**Depends on**: Phase 16
**Priority:** P0/P1 - CRITICAL
**Plans**: 2 plans

Plans:
- [x] 17-01: DOCX converter throw-based errors + output verification + rename handling (completed 2026-02-10)
- [x] 17-02: PDF timeout errors + CLI unification (completed 2026-02-10)

Findings addressed:
- P0: DOCX converter returns {success: false} instead of throwing (asymmetric with PDF)
- P1: No output file verification after LibreOffice execution
- P1: Missing rename error handling (orphaned files)
- P1: Timeout errors not distinguished (ErrorCodes.TIMEOUT never used in PDF path)

### Phase 18: Type Design Cleanup

**Goal**: Remove dead type fields, replace boolean+optional anti-patterns with discriminated unions, fix unsafe Platform cast, add HeadingLevel type
**Depends on**: Phase 17 (DOCXResult changes)
**Priority:** P2
**Plans**: 1 plan

Plans:
- [x] 18-01: Remove dead fields, add HeadingLevel, fix Platform cast (2 tasks, completed 2026-02-10)

Findings addressed:
- PDFResult.pageCount never populated (dead field)
- DOCXOptions.preserveStyles never read (dead field)
- DOCXResult allows invalid states (discriminated union needed)
- DependencyStatus same boolean+optional anti-pattern (deferred - low value)
- Platform unsafe cast (process.platform as Platform)
- Chapter.level typed as number instead of 1|2|3|4|5|6

### Phase 19: Architecture & Packaging

**Goal**: Break circular dependency, fix public API exports, add package.json exports field, dynamic CLI version
**Depends on**: Phase 18 (type changes affect exports)
**Priority:** P2
**Plans**: 1 plan

Plans:
- [x] 19-01: Break circular dep, curate public API, exports field, dynamic version (2 tasks, completed 2026-02-10)

Findings addressed:
- Circular dependency: dependencies.ts imports from docx-converter.ts
- ConversionError/ErrorCodes not exported from index.ts
- Missing exports field in package.json
- CLI version hardcoded as '1.0.0'
- findSoffice/verifyLibreOffice unnecessarily exposed in public API

### Phase 20: Silent Failure Fixes

**Goal**: Fix TOCTOU in overwrite protection and ensureOutputDirectory, fix findSoffice swallowing EACCES, add error cause chains, fix convertHTMLStringToPDF timeout
**Depends on**: Phase 17 (error handling patterns established)
**Priority:** P1/P2
**Plans**: 1 plan

Plans:
- [x] 20-01: TOCTOU fixes, EACCES handling, error cause chains (2 tasks, completed 2026-02-10)

Findings addressed:
- P1: TOCTTOU in overwrite protection (cli.ts:144-152)
- P1: ensureOutputDirectory TOCTOU + EACCES misinterpretation
- P1: findSoffice swallows EACCES (reports "not found" for permission errors)
- P2: convertHTMLStringToPDF ignores options.timeout
- P2: loadHTML loses original error context (no {cause})

### Phase 21: Test Defect Fixes

**Goal**: Fix existing test bugs: un-awaited fs.writeFile, silent pass-through tests, replace source-scanning tests with behavioral tests
**Depends on**: Phase 17 (error handling changes affect test expectations)
**Priority:** P1
**Plans**: 1 plan

Plans:
- [x] 21-01: Fix CLI silent pass-through, un-awaited writeFile, source-scanning tests, PDF magic bytes (3 tasks, completed 2026-02-14)

Findings addressed:
- P1: CLI test silent pass-through (missing expect.assertions)
- P1: Un-awaited fs.writeFile race condition in cli.test.ts
- P2: DOCX tests scan source code instead of behavioral testing
- P2: E2E tests don't validate PDF magic bytes (%PDF-)

### Phase 22: Test Coverage Expansion

**Goal**: Add tests for untested public API functions (convertHTMLFileToPDF, convertHTMLStringToPDF, convertHTMLFileToDOCX), improve CLI instrumented coverage
**Depends on**: Phase 21 (test defects fixed first)
**Priority:** P1
**Plans**: 3 plans

Plans:
- [x] 22-01: PDF converter API tests - convertToPDF, convertHTMLFileToPDF, convertHTMLStringToPDF (2 tasks, completed 2026-02-15)
- [x] 22-02: DOCX converter mocked tests - convertToDOCX, convertHTMLFileToDOCX (2 tasks, completed 2026-02-15)
- [x] 22-03: CLI validation logic extraction and tests (3 tasks, completed 2026-02-15)

Findings addressed:
- cli.ts at 0% instrumented coverage
- convertHTMLFileToPDF and convertHTMLStringToPDF completely untested
- convertHTMLFileToDOCX completely untested

### Phase 23: Resilience & Final Polish

**Goal**: Add SIGINT/SIGTERM handler for graceful cleanup, add exhaustiveness check in createError switch, final verification
**Depends on**: Phase 22
**Priority:** P2
**Plans**: 1 plan

Plans:
- [x] 23-01: Signal handlers, exhaustive switch, final verification (3 tasks, completed 2026-02-15)

Findings addressed:
- P2: No SIGINT handler (orphaned files, zombie Chromium)
- P2: createError switch has no compile-time exhaustiveness check

---

## Milestone Summary

**Key Decisions:**

- Promise-lock pattern for singleton resources, null-before-close for cleanup safety
- Throw-on-failure pattern: converters throw ConversionError, callers use try/catch
- DOCXResult simplified to { outputPath: string } - "if you got a result, it worked"
- Named exports in index.ts over export * - explicit API surface control
- createRequire pattern for JSON imports in ESM projects
- Atomic mkdir: fs.mkdir({ recursive: true }) instead of access+mkdir
- Error cause chains: always pass { cause: error } when re-throwing
- Extract-to-test: move inline CLI logic to importable helpers for vitest instrumentation
- Separate mocked test files when vi.mock conflicts with existing integration tests
- TypeScript never type for exhaustive switch enforcement on ErrorCodes

**Issues Resolved:**

- All 29 findings from 5-agent code review addressed
- P0: Browser singleton race condition fixed
- P0: DOCX/PDF error handling unified
- P1: TOCTOU races eliminated
- P1: Silent test pass-throughs fixed
- P1: All public API functions tested

**Issues Deferred:**

- DependencyStatus discriminated union refactor (P2, low value for churn)

**Technical Debt Incurred:**

- None significant - milestone specifically targeted debt reduction

---

_For current project status, see .planning/ROADMAP.md_
