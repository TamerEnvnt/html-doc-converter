# Milestone v1.4: Review Findings

**Status:** SHIPPED 2026-02-22
**Phases:** 29-36
**Total Plans:** 8

## Overview

Address 28 findings from comprehensive 5-agent codebase review -- fix critical bugs, eliminate silent failures, improve error messages, harden process lifecycle, clean up API surface, strengthen types, and expand test coverage.

## Phases

### Phase 29: Critical Fixes

**Goal**: Fix 3 P1 bugs: signal handler hang on Ctrl+C, browser launch no timeout, DOCX timeout || vs ??
**Depends on**: Milestone v1.3 complete
**Plans**: 1/1 complete

Plans:
- [x] 29-01: Fix signal handler hang, browser launch timeout, DOCX ?? operator (3 tasks)

Findings addressed:
- P1: Signal handlers can hang forever (no force-exit timeout, no re-entrance guard)
- P1: Browser launch has no timeout (puppeteer.launch() hangs indefinitely)
- P1: DOCX timeout uses || instead of ?? (timeout:0 silently becomes 60000)

### Phase 30: Error Message Quality

**Goal**: Wrap browser launch errors with specific messages, use ConversionError in html-parser, add verbose logging to silent catch blocks
**Depends on**: Phase 29
**Plans**: 1/1 complete

Plans:
- [x] 30-01: html-parser ConversionError + verbose logging in cleanup catch blocks (2 tasks)

Findings addressed:
- P1: Browser launch errors give misleading "PDF generation failed" message (fixed in Phase 29)
- P1: html-parser throws plain Error instead of ConversionError
- P2: closeBrowser() and page.close() silently discard all errors without verbose logging

### Phase 31: Process Lifecycle Hardening

**Goal**: Refactor process.exit() placement for reliable cleanup, add unhandledRejection handler
**Depends on**: Phase 30
**Plans**: 1/1 complete

Plans:
- [x] 31-01: Move process.exit() after cleanup + unhandledRejection handler (2 tasks)

Findings addressed:
- P2: process.exit() inside try block relies on fragile cleanup ordering
- P2: No unhandledRejection handler (raw stack traces on uncaught rejections)

### Phase 32: Silent Failure Elimination

**Goal**: Distinguish expected from unexpected errors in 5 catch blocks across soffice, dependencies, CLI, and platform
**Depends on**: Phase 31
**Plans**: 1/1 complete

Plans:
- [x] 32-01: Tighten 5 catch blocks across soffice, dependencies, platform, docx-converter (2 tasks)

Findings addressed:
- P1: which/where fallback catches ALL errors as "not found" (EPERM, EMFILE, ENOMEM)
- P1: Chromium detection catches ALL errors as "not installed" (corrupted Puppeteer)
- P2: fs.access catch blocks treat EACCES/EIO as "file doesn't exist"
- P2: Platform fallback to linux only logged at verbose level
- P2: LibreOffice version regex too strict for 4-part versions

### Phase 33: API & Performance Cleanup

**Goal**: Remove getBrowser() from public API, extract timeout constants, fix O(n^2) string concatenation, add scale NaN validation
**Depends on**: Phase 32
**Plans**: 1/1 complete

Plans:
- [x] 33-01: Remove getBrowser from API, extract timeout constants, fix O(n^2) concat, NaN validation (2 tasks)

Findings addressed:
- P2: getBrowser() exposed in public API (implementation detail)
- P2: Hardcoded timeout magic numbers (60000 in 5+ locations)
- P2: String concatenation O(n^2) in chapter content extraction
- P3: Scale NaN validation gap

### Phase 34: Type Safety

**Goal**: Add readonly to html-parser types, name anonymous return types, narrow CLIOptions.format
**Depends on**: Phase 33
**Plans**: 1/1 complete

Plans:
- [x] 34-01: Add readonly to types, name return types, narrow CLIOptions.format (2 tasks)

Findings addressed:
- P2: Chapter, DocumentMetadata, ParsedDocument missing readonly (0/13 fields)
- P2: DependencyCheckResult.allFound is derived/redundant field
- P2: validateInputFile return type is anonymous
- P2: CLIOptions.format typed as unconstrained string

### Phase 35: Test Coverage

**Goal**: Fill test gaps: CLI docx-only path, partial failure exit code, version extraction mocks, isHeadingLevel direct tests
**Depends on**: Phase 34
**Plans**: 1/1 complete

Plans:
- [x] 35-01: Fill 5 test gaps: isHeadingLevel, DOCX outputDir, mocked dependency versions, CLI --docx-only, partial failure exit code (2 tasks, 17 new tests)

Findings addressed:
- P2: No CLI test for --docx-only path
- P2: No test for partial failure exit code (exit 2)
- P2: No mocked tests for checkChromium/checkLibreOffice version extraction
- P2: isHeadingLevel type guard not directly tested
- P3: DOCX outputDir success path not tested

### Phase 36: Verification

**Goal**: Full test suite run, coverage verification, confirm all 26 findings addressed
**Depends on**: Phase 35
**Plans**: 1/1 complete

Plans:
- [x] 36-01: Full test suite verification + 26-finding audit (2 tasks, all PASS)

---

## Milestone Summary

**Key Decisions:**

- Nullish coalescing (??) over logical OR (||) for timeout options preserving explicit 0
- Centralized timeout constants in utils/constants.ts instead of inline magic numbers
- Array-join pattern over string concatenation for O(n) performance
- Named return types (ValidatedInput) over anonymous object types
- OutputFormat union type over unconstrained string for CLI format option

**Issues Resolved:**

- Signal handler hang on Ctrl+C (re-entrance guard + force-exit timeout)
- Browser launch hanging indefinitely (30s BROWSER_LAUNCH_TIMEOUT_MS)
- DOCX timeout:0 silently becoming 60000 (?? vs ||)
- 5 catch-all blocks masking unexpected errors (EPERM, EMFILE, ENOMEM)
- Plain Error thrown instead of ConversionError in html-parser
- Silent cleanup failures with no logging

**Issues Deferred:**

- None (all 26 findings addressed, milestone complete)

**Technical Debt Incurred:**

- Coverage dipped slightly from 82.2% to 81.18% stmts (new code paths from phases 29-33 not fully exercised by tests)
- readonly on Chapter.children is shallow (allows .push() mutation)

---

_For current project status, see .planning/ROADMAP.md_
